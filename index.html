<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>CPM Monitor</title>

  <!-- ใช้กับ repo ชื่อ cpmpateint-data บน GitHub Pages -->
  <base href="/cpmpateint-data/">

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="bg-overlay"></div>

  <div id="appWrapper">
    <div class="logo-block">
      <div class="logo-circle">CPM</div>
      <div class="logo-text">
        <h1>CPM Monitor</h1>
        <p>Continuous Passive Motion Dashboard</p>
      </div>
    </div>

    <!-- กล่องล็อกอิน / สมัครสมาชิก -->
    <div id="loginBox" class="card">
      <h3>เข้าสู่ระบบ</h3>

      <label class="field-label">อีเมล</label>
      <input id="email" type="email" placeholder="เช่น you@example.com">

      <label class="field-label">รหัสผ่าน</label>
      <input id="password" type="password" placeholder="รหัสผ่าน">

      <div class="button-row">
        <button id="loginBtn" class="btn primary">เข้าสู่ระบบ</button>
        <button id="registerBtn" class="btn ghost small">สมัครสมาชิก</button>
        <button id="logoutBtn" class="btn danger small" style="display:none;">ออกจากระบบ</button>
      </div>

      <button id="fullscreenBtn" class="btn ghost small fs-btn">
        เต็มหน้าจอ
      </button>

      <p id="loginMsg" class="msg"></p>
      <p id="hint">* โหมดทดลอง: ใส่อีเมลและรหัสผ่านอะไรก็ได้เพื่อเข้าสู่ระบบ</p>
    </div>

    <!-- หน้า Main (เลือกผู้ป่วย + Monitor + ปุ่มหน้าถัดไป) -->
    <div id="mainPage" style="display:none;">
      <!-- กล่องเลือกผู้ป่วย -->
      <div id="patientBox" class="card" style="display:none;">
        <h3>เลือกผู้ป่วย</h3>

        <div class="field-group">
          <label class="field-label">ผู้ป่วย</label>
          <select id="patientSelect">
            <option value="">— เลือกผู้ป่วย —</option>
          </select>
        </div>

        <div id="patientInfo" class="patient-info" style="display:none;">
          <div><span class="label">ชื่อ-สกุล:</span> <span id="pName" class="value-sm">-</span></div>
          <div><span class="label">รหัสผู้ป่วย (4 หลัก):</span> <span id="pHN" class="value-sm">-</span></div>
          <div><span class="label">Device ID:</span> <span id="pDevice" class="pill-dev">-</span></div>
          <div><span class="label">หมายเหตุ:</span> <span id="pNote" class="value-sm">-</span></div>
        </div>

        <hr class="divider">

        <button id="toggleNewPatientBtn" class="btn ghost small">
          + สร้างข้อมูลผู้ป่วยใหม่
        </button>

        <div id="newPatientForm" class="new-patient" style="display:none;">
          <h4>เพิ่มผู้ป่วยใหม่</h4>

          <label class="field-label">ชื่อ-สกุล</label>
          <input id="newName" type="text" placeholder="เช่น นาย กายภาพ ตัวอย่าง">

          <label class="field-label">รหัสผู้ป่วย (4 หลัก)</label>
          <input id="newHN" type="text" maxlength="4" placeholder="เช่น 0123">

          <label class="field-label">Device ID ที่ใช้งาน (เช่น CPM01)</label>
          <input id="newDeviceId" type="text" placeholder="เช่น CPM01">

          <label class="field-label">หมายเหตุเพิ่มเติม</label>
          <textarea id="newNote" rows="2" placeholder="เช่น ข้อเท้าขวา post-op 3 วัน"></textarea>

          <button id="savePatientBtn" class="btn primary small">บันทึกผู้ป่วย</button>
          <p id="patientMsg" class="msg"></p>
        </div>

        <!-- ปุ่มลบผู้ป่วย -->
        <div class="button-row" style="margin-top:8px;">
          <button id="deletePatientBtn" class="btn danger small" style="display:none;">
            ลบผู้ป่วยนี้ (พร้อมประวัติ)
          </button>
        </div>
        <p id="deleteMsg" class="msg"></p>
      </div>

      <!-- กล่องแสดงสถานะ CPM -->
      <div id="monitorBox" class="card monitor" style="display:none;">
        <h3>สถานะเครื่อง CPM</h3>
        <div id="statusBox">
          <div class="item-row">
            <span class="label">สถานะ</span>
            <span class="value-pill" id="stateText">-</span>
          </div>

          <div class="item-row">
            <span class="label">มุมใช้งานครั้งล่าสุด</span>
            <span class="value" id="angleText">-</span>
          </div>

          <div class="item-row">
            <span class="label">ระยะเวลา</span>
            <span class="value" id="remText">-</span>
          </div>

          <div class="item-row">
            <span class="label">อัปเดตล่าสุด</span>
            <span class="value time" id="timeText">-</span>
          </div>
        </div>
      </div>

      <!-- ปุ่มไปหน้าถัดไป -->
      <div id="mainNavRow" class="nav-row" style="display:none;">
        <button id="toHistoryBtn" class="btn ghost small">หน้าถัดไป (ประวัติผู้ป่วย)</button>
      </div>
    </div>

    <!-- หน้า History -->
    <div id="historyPage" class="card history" style="display:none;">
      <div class="history-header">
        <h3>ประวัติการทำ CPM</h3>
        <p class="history-sub">แสดงประวัติของผู้ป่วยที่เลือก (จาก Firebase)</p>
      </div>

      <table class="history-table">
        <thead>
          <tr>
            <th>วันที่ / เวลา</th>
            <th>มุมที่ใช้</th>
            <th>ระยะเวลา</th>
            <th>Device</th>
            <th>หมายเหตุ</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr>
            <td colspan="5" class="empty">ยังไม่มีข้อมูล</td>
          </tr>
        </tbody>
      </table>

      <div class="nav-row">
        <button id="backToMainBtn" class="btn ghost small">ย้อนกลับหน้าหลัก</button>
        <button id="backToLoginBtn" class="btn danger small">ย้อนกลับหน้าล็อกอิน</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // ตั้งค่า Firebase Realtime DB (REST API)
    // ==========================
    const FIREBASE_URL  = "https://ankle-cpm-default-rtdb.asia-southeast1.firebasedatabase.app";
    const FIREBASE_AUTH = null; // ถ้าใช้ token ให้ใส่สตริงแทน null เช่น "abcd1234TOKEN"

    function buildUrl(path) {
      let url = FIREBASE_URL + path;
      if (FIREBASE_AUTH) {
        const sep = url.includes("?") ? "&" : "?";
        url += sep + "auth=" + FIREBASE_AUTH;
      }
      return url;
    }

    // ==========================
    // อ้างอิง element ในหน้า
    // ==========================
    const loginBox       = document.getElementById("loginBox");
    const mainPage       = document.getElementById("mainPage");
    const historyPage    = document.getElementById("historyPage");
    const patientBox     = document.getElementById("patientBox");
    const monitorBox     = document.getElementById("monitorBox");
    const mainNavRow     = document.getElementById("mainNavRow");

    const loginBtn       = document.getElementById("loginBtn");
    const registerBtn    = document.getElementById("registerBtn");
    const logoutBtn      = document.getElementById("logoutBtn");
    const loginMsg       = document.getElementById("loginMsg");
    const emailInput     = document.getElementById("email");
    const passwordInput  = document.getElementById("password");
    const fullscreenBtn  = document.getElementById("fullscreenBtn");

    const patientSelect  = document.getElementById("patientSelect");
    const patientInfo    = document.getElementById("patientInfo");
    const pNameEl        = document.getElementById("pName");
    const pHNEl          = document.getElementById("pHN");
    const pDeviceEl      = document.getElementById("pDevice");
    const pNoteEl        = document.getElementById("pNote");

    const toggleNewPatientBtn = document.getElementById("toggleNewPatientBtn");
    const newPatientForm      = document.getElementById("newPatientForm");
    const newNameInput        = document.getElementById("newName");
    const newHNInput          = document.getElementById("newHN");
    const newDeviceInput      = document.getElementById("newDeviceId");
    const newNoteInput        = document.getElementById("newNote");
    const savePatientBtn      = document.getElementById("savePatientBtn");
    const patientMsgEl        = document.getElementById("patientMsg");

    const deletePatientBtn    = document.getElementById("deletePatientBtn");
    const deleteMsgEl         = document.getElementById("deleteMsg");

    const stateEl  = document.getElementById("stateText");
    const angleEl  = document.getElementById("angleText");
    const remEl    = document.getElementById("remText");
    const timeEl   = document.getElementById("timeText");

    const historyBody   = document.getElementById("historyBody");
    const toHistoryBtn  = document.getElementById("toHistoryBtn");
    const backToMainBtn = document.getElementById("backToMainBtn");
    const backToLoginBtn= document.getElementById("backToLoginBtn");

    // ==========================
    // Login หน้าเว็บ (โหมดทดลอง)
    // ==========================
    function showMainUI() {
      loginBox.style.display   = "none";
      mainPage.style.display   = "block";
      patientBox.style.display = "block";
      monitorBox.style.display = "block";
      mainNavRow.style.display = "block";
      logoutBtn.style.display  = "inline-block";
      loginMsg.textContent     = "";
    }

    function showLoginUI() {
      loginBox.style.display   = "block";
      mainPage.style.display   = "none";
      historyPage.style.display= "none";
      logoutBtn.style.display  = "none";
    }

    loginBtn.addEventListener("click", (e) => {
      e.preventDefault();
      const email = emailInput.value.trim();
      const pass  = passwordInput.value.trim();
      if (!email || !pass) {
        loginMsg.textContent = "กรุณากรอกอีเมลและรหัสผ่าน (ใส่อะไรก็ได้ในโหมดทดลอง)";
        loginMsg.style.color = "yellow";
        return;
      }
      showMainUI();
    });

    registerBtn.addEventListener("click", (e) => {
      e.preventDefault();
      loginMsg.textContent = "โหมดทดลอง: ปุ่มสมัครสมาชิกยังไม่เชื่อมระบบจริง";
      loginMsg.style.color = "lightgray";
    });

    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      emailInput.value    = "";
      passwordInput.value = "";
      showLoginUI();
    });

    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(err => {
          console.error("Error attempting fullscreen:", err);
        });
      } else {
        document.exitFullscreen();
      }
    });

    // เริ่มต้นที่หน้า Login
    showLoginUI();

    // ==========================
    // ฟังก์ชันช่วย format เวลา
    // ==========================
    function formatMMSS(sec) {
      sec = Math.max(0, sec | 0);
      const m  = Math.floor(sec / 60);
      const s  = sec % 60;
      const mm = (m < 10 ? "0" : "") + m;
      const ss = (s < 10 ? "0" : "") + s;
      return `${mm}:${ss}`;
    }

    function formatTimeFromSeconds(tsSec) {
      if (!tsSec) return "-";
      const d = new Date(tsSec * 1000);
      const pad = (n) => n.toString().padStart(2, "0");
      const dd  = pad(d.getDate());
      const mm  = pad(d.getMonth() + 1);
      const yy  = d.getFullYear() + 543; // พ.ศ.
      const hh  = pad(d.getHours());
      const mi  = pad(d.getMinutes());
      const ss  = pad(d.getSeconds());
      return `${dd}/${mm}/${yy} ${hh}:${mi}:${ss}`;
    }

    // ==========================
    // จัดการข้อมูลผู้ป่วย
    // ==========================
    let patientMap = {};       // id -> data
    let currentPatientId = null;

    async function loadPatients() {
      try {
        const res = await fetch(buildUrl("/patients.json"));
        const data = await res.json();

        patientMap = {};
        // ล้าง option เก่า (เหลือ placeholder ตัวแรก)
        while (patientSelect.options.length > 1) {
          patientSelect.remove(1);
        }

        if (!data) {
          return;
        }

        Object.keys(data).forEach((id) => {
          const p = data[id];
          patientMap[id] = p;
          const opt = document.createElement("option");
          const name = p.name || "";
          const lastname = p.lastname || "";
          opt.value = id;
          opt.textContent = `${name} ${lastname} (${id})`;
          patientSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("loadPatients error:", err);
      }
    }

    // แสดง/ซ่อนฟอร์มผู้ป่วยใหม่
    toggleNewPatientBtn.addEventListener("click", () => {
      if (newPatientForm.style.display === "none" || newPatientForm.style.display === "") {
        newPatientForm.style.display = "block";
      } else {
        newPatientForm.style.display = "none";
      }
    });

    // บันทึกผู้ป่วยใหม่ (ใช้ newHN เป็นรหัส 4 หลัก)
    savePatientBtn.addEventListener("click", async () => {
      const name     = newNameInput.value.trim();
      const id       = newHNInput.value.trim();
      const deviceId = newDeviceInput.value.trim();
      const note     = newNoteInput.value.trim();

      patientMsgEl.textContent = "";
      deleteMsgEl.textContent  = "";

      if (!name) {
        patientMsgEl.textContent = "กรุณากรอกชื่อ-สกุล";
        patientMsgEl.style.color = "red";
        return;
      }
      if (id.length !== 4 || !/^\d{4}$/.test(id)) {
        patientMsgEl.textContent = "รหัสผู้ป่วยต้องเป็นตัวเลข 4 หลัก";
        patientMsgEl.style.color = "red";
        return;
      }

      const payload = {
        patientId: id,
        name: name,
        lastname: "",       // ถ้าอยากแยกชื่อ-นามสกุล เพิ่ม input อีกช่องได้
        deviceId: deviceId || "",
        note: note || "",
        createdAt: Date.now()
      };

      try {
        const url = buildUrl("/patients/" + id + ".json");
        const res = await fetch(url, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);

        patientMsgEl.textContent = "บันทึกข้อมูลผู้ป่วยเรียบร้อย";
        patientMsgEl.style.color = "lightgreen";

        newNameInput.value   = "";
        newHNInput.value     = "";
        newDeviceInput.value = "";
        newNoteInput.value   = "";
        newPatientForm.style.display = "none";

        // โหลดใหม่ + เลือกคนที่เพิ่งสร้าง
        await loadPatients();
        patientSelect.value = id;
        onPatientSelected(id);
      } catch (err) {
        console.error("savePatient error:", err);
        patientMsgEl.textContent = "บันทึกไม่สำเร็จ: " + err;
        patientMsgEl.style.color = "red";
      }
    });

    // ลบผู้ป่วย + ประวัติที่ patientId ตรงกัน
    deletePatientBtn.addEventListener("click", async () => {
      deleteMsgEl.textContent = "";
      if (!currentPatientId) {
        deleteMsgEl.textContent = "กรุณาเลือกผู้ป่วยก่อนลบ";
        deleteMsgEl.style.color = "yellow";
        return;
      }

      const ok = window.confirm(
        "ยืนยันลบผู้ป่วยนี้และประวัติทั้งหมดของรหัส " + currentPatientId + " ?"
      );
      if (!ok) return;

      try {
        // ลบ /patients/{id}
        const urlPatient = buildUrl("/patients/" + currentPatientId + ".json");
        await fetch(urlPatient, { method: "DELETE" });

        // ลบรายการใน cpm_results ที่ patientId ตรงกัน
        const urlHist = buildUrl("/cpm_results.json");
        const resHist = await fetch(urlHist);
        const histData = await resHist.json();

        if (histData) {
          const deletes = [];
          for (const key in histData) {
            const item = histData[key];
            if (item && item.patientId === currentPatientId) {
              const delUrl = buildUrl("/cpm_results/" + key + ".json");
              deletes.push(fetch(delUrl, { method: "DELETE" }));
            }
          }
          await Promise.all(deletes);
        }

        deleteMsgEl.textContent = "ลบข้อมูลผู้ป่วยและประวัติเรียบร้อย";
        deleteMsgEl.style.color = "lightgreen";

        currentPatientId = null;
        patientInfo.style.display = "none";
        deletePatientBtn.style.display = "none";
        patientSelect.value = "";
        clearHistoryTable();
        clearMonitor();
        await loadPatients();
      } catch (err) {
        console.error("deletePatient error:", err);
        deleteMsgEl.textContent = "ลบไม่สำเร็จ: " + err;
        deleteMsgEl.style.color = "red";
      }
    });

    // เมื่อเปลี่ยนผู้ป่วยใน select
    patientSelect.addEventListener("change", () => {
      const id = patientSelect.value;
      onPatientSelected(id);
    });

    function onPatientSelected(id) {
      deleteMsgEl.textContent = "";
      if (!id || !patientMap[id]) {
        currentPatientId = null;
        patientInfo.style.display = "none";
        deletePatientBtn.style.display = "none";
        clearHistoryTable();
        clearMonitor();
        return;
      }

      currentPatientId = id;
      const p = patientMap[id];

      pNameEl.textContent    = (p.name || "") + (p.lastname ? " " + p.lastname : "");
      pHNEl.textContent      = p.patientId || id;
      pDeviceEl.textContent  = p.deviceId || "-";
      pNoteEl.textContent    = p.note || "-";
      patientInfo.style.display = "block";
      deletePatientBtn.style.display = "inline-block";

      loadHistoryForPatient(currentPatientId);
    }

    // ==========================
    // ประวัติ CPM ของผู้ป่วย
    // ==========================
    function clearHistoryTable() {
      historyBody.innerHTML = `
        <tr>
          <td colspan="5" class="empty">ยังไม่มีข้อมูล</td>
        </tr>
      `;
    }

    function clearMonitor() {
      stateEl.textContent = "-";
      angleEl.textContent = "-";
      remEl.textContent   = "-";
      timeEl.textContent  = "-";
    }

    async function loadHistoryForPatient(patientId) {
      clearHistoryTable();
      clearMonitor();
      if (!patientId) return;

      try {
        const url = buildUrl("/cpm_results.json");
        const res = await fetch(url);
        const data = await res.json();

        if (!data) {
          return;
        }

        const rows = [];
        for (const key in data) {
          const item = data[key];
          if (!item || item.patientId !== patientId) continue;
          rows.push(item);
        }

        if (rows.length === 0) {
          clearHistoryTable();
          return;
        }

        // เรียงจากใหม่ไปเก่า ตาม ts
        rows.sort((a, b) => (b.ts || 0) - (a.ts || 0));

        historyBody.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");

          const tsDisp = r.ts ? formatTimeFromSeconds(r.ts) : "-";
          const angleDisp = (r.angle1 != null && r.angle2 != null)
            ? `${r.angle1}° - ${r.angle2}°`
            : "-";
          const timeDisp  = (r.workTimeSec != null)
            ? `${r.workTimeSec} วินาที (${formatMMSS(r.workTimeSec)})`
            : "-";
          const devDisp   = r.device || r.deviceId || "ESP32-CPM";
          const noteDisp  = r.note || "";

          tr.innerHTML = `
            <td>${tsDisp}</td>
            <td>${angleDisp}</td>
            <td>${timeDisp}</td>
            <td>${devDisp}</td>
            <td>${noteDisp}</td>
          `;
          historyBody.appendChild(tr);
        });

        // เอา session ล่าสุดไปแสดงที่ Monitor
        const latest = rows[0];
        stateEl.textContent = "FINISHED";
        angleEl.textContent = (latest.angle1 != null && latest.angle2 != null)
          ? `${latest.angle1}° - ${latest.angle2}°`
          : "-";
        remEl.textContent   = (latest.workTimeSec != null)
          ? `${latest.workTimeSec} วินาที (${formatMMSS(latest.workTimeSec)})`
          : "-";
        timeEl.textContent  = latest.ts ? formatTimeFromSeconds(latest.ts) : "-";

      } catch (err) {
        console.error("loadHistoryForPatient error:", err);
      }
    }

    // ==========================
    // สลับหน้า Main <-> History
    // ==========================
    toHistoryBtn.addEventListener("click", () => {
      historyPage.style.display = "block";
      mainPage.style.display    = "none";
    });

    backToMainBtn.addEventListener("click", () => {
      historyPage.style.display = "none";
      mainPage.style.display    = "block";
    });

    backToLoginBtn.addEventListener("click", () => {
      historyPage.style.display = "none";
      showLoginUI();
    });

    // ==========================
    // โหลดข้อมูลผู้ป่วยครั้งแรกเมื่อเปิดหน้า
    // ==========================
    document.addEventListener("DOMContentLoaded", () => {
      loadPatients();
    });
  </script>
</body>
</html>
