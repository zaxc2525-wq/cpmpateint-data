<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>CPM Monitor</title>
  <link rel="icon" href="/cpmpateint-data/favicon.ico">
  <style>
    /* ================================
       BASE + THEME VARIABLES
    ================================= */
    * { box-sizing: border-box; }
    html, body { margin: 0; padding: 0; height: 100%; }

    body{
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px 0;
      min-height: 100vh;
      position: relative;
      background: var(--body-bg);
      color: #e5e7eb;
      transition: background 0.35s ease, color 0.25s ease;
      overflow-x: hidden;
      overflow-y: auto;
    }

    body{
      --body-bg: radial-gradient(circle at top left, #2c7cf7, #111827);

      --card-bg: rgba(15, 23, 42, 0.9);
      --card-border: rgba(148, 163, 184, 0.35);
      --card-radius: 24px;

      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-strong: #f9fafb;

      --input-bg: rgba(30, 41, 59, 0.8);
      --input-border: rgba(148, 163, 184, 0.45);
      --input-placeholder: #6b7280;

      --primary1: #38bdf8;
      --primary2: #2563eb;
      --danger-border: rgba(248, 113, 113, 0.7);
      --danger-text: #fca5a5;
      --accent-green1: #22c55e;
      --accent-green2: #16a34a;

      --btn-text-main: #e5e7eb;
      --btn-border-soft: rgba(148, 163, 184, 0.45);

      --shadow-main: 0 22px 60px rgba(0, 0, 0, 0.55);
      --shadow-soft: 0 10px 30px rgba(0, 0, 0, 0.45);
    }

    body[data-theme="dark"] {
      --body-bg: radial-gradient(circle at top left, #2c7cf7, #111827);
    }

    body[data-theme="light"] {
      --body-bg: radial-gradient(circle at top left, #e0f2ff, #f8fbff);

      --card-bg: #ffffff;
      --card-border: rgba(148, 163, 184, 0.35);
      --text-main: #111827;
      --text-soft: #6b7280;
      --text-strong: #0f172a;

      --input-bg: #f9fafb;
      --input-border: rgba(148, 163, 184, 0.55);
      --input-placeholder: #9ca3af;

      --primary1: #3b82f6;
      --primary2: #2563eb;
      --danger-border: rgba(239, 68, 68, 0.75);
      --danger-text: #b91c1c;
      --accent-green1: #16a34a;
      --accent-green2: #22c55e;

      --btn-text-main: #111827;
      --btn-border-soft: rgba(148, 163, 184, 0.55);

      --shadow-main: 0 20px 55px rgba(15, 23, 42, 0.22);
      --shadow-soft: 0 10px 30px rgba(15, 23, 42, 0.18);
    }

    body[data-theme="his"] {
      --body-bg: radial-gradient(circle at top left, #0f172a, #020617);

      --card-bg: #020617;
      --card-border: rgba(51, 65, 85, 0.9);
      --text-main: #e5e7eb;
      --text-soft: #9ca3af;
      --text-strong: #f9fafb;

      --input-bg: #020617;
      --input-border: rgba(51, 65, 85, 0.9);
      --input-placeholder: #64748b;

      --primary1: #06b6d4;
      --primary2: #0ea5e9;
      --danger-border: rgba(248, 113, 113, 0.8);
      --danger-text: #fca5a5;
      --accent-green1: #22c55e;
      --accent-green2: #16a34a;

      --btn-text-main: #e5e7eb;
      --btn-border-soft: rgba(51, 65, 85, 0.9);

      --shadow-main: 0 22px 70px rgba(15, 23, 42, 0.9);
      --shadow-soft: 0 12px 40px rgba(15, 23, 42, 0.8);
    }

    .bg-overlay{
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: -1;
    }
    .bg-overlay::before,
    .bg-overlay::after{
      content:"";
      position:absolute;
      border-radius:999px;
      filter: blur(80px);
      opacity: 0.32;
    }
    .bg-overlay::before{
      width:320px;height:320px;
      background:#38bdf8;
      top:-80px;right:-40px;
    }
    .bg-overlay::after{
      width:320px;height:320px;
      background:#4ade80;
      bottom:-90px;left:-40px;
    }
    body[data-theme="light"] .bg-overlay::before,
    body[data-theme="light"] .bg-overlay::after{
      opacity:0.14;
      filter: blur(90px);
    }
    body[data-theme="his"] .bg-overlay::before{ background:#0ea5e9; }
    body[data-theme="his"] .bg-overlay::after{ background:#22c55e; }

    #appWrapper{
      width:100%;
      max-width:960px;
      padding:22px 26px 26px;
      border-radius: var(--card-radius);
      background: var(--card-bg);
      border:1px solid var(--card-border);
      box-shadow: var(--shadow-main);
      color: var(--text-main);
      margin:0 auto;
    }

    @media (max-width:768px){
      #appWrapper{ max-width:480px; padding:18px 16px 22px; }
    }

    .top-bar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      margin-bottom:12px;
    }
    .logo-header{
      display:flex;align-items:center;gap:12px;
    }
    .logo-header img{
      height:48px;width:auto;object-fit:contain;
    }
    .title-block{ flex:1; text-align:center; }
    .title-block h1{
      margin:0;font-size:22px;font-weight:600;color:var(--text-strong);
    }
    .title-block p{
      margin:4px 0 0;font-size:12px;color:var(--text-soft);
    }

    .theme-switcher{
      display:inline-flex;
      padding:3px;
      border-radius:999px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(148,163,184,0.5);
      gap:2px;
    }
    body[data-theme="light"] .theme-switcher{
      background:#f1f5f9;border-color:rgba(148,163,184,0.6);
    }
    .theme-btn{
      border:none;background:transparent;color:#9ca3af;
      font-size:11px;padding:5px 10px;border-radius:999px;
      cursor:pointer;
      transition: background 0.2s ease, color 0.2s ease, transform 0.06s ease;
      display:flex;align-items:center;gap:4px;white-space:nowrap;
    }
    .theme-btn span.dot{
      width:6px;height:6px;border-radius:999px;background:#6b7280;
    }
    .theme-btn.active{
      background:linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#f9fafb;
      box-shadow:0 4px 14px rgba(37,99,235,0.5);
      transform: translateY(-1px);
    }
    .theme-btn.active span.dot{ background:#f9fafb; }

    .card{
      background: var(--card-bg);
      border-radius:18px;
      border:1px solid var(--card-border);
      padding:16px 18px 14px;
      box-shadow: var(--shadow-soft);
      margin-top:14px;
    }
    .card h3{
      margin:0 0 10px;
      font-size:16px;font-weight:600;color:var(--text-strong);
    }
    .divider{
      border:none;border-top:1px solid rgba(148,163,184,0.35);
      margin:10px 0;
    }
    .field-label{
      display:block;font-size:13px;color:var(--text-soft);
      margin-top:6px;margin-bottom:4px;
    }
    .field-group{ margin-bottom:8px; }

    input, select, textarea{
      width:100%;
      padding:9px 11px;
      border-radius:10px;
      border:1px solid var(--input-border);
      background: var(--input-bg);
      color: var(--text-main);
      font-size:14px;
      outline:none;
      transition: border 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
    }
    input::placeholder, textarea::placeholder{ color: var(--input-placeholder); }
    input:focus, select:focus, textarea:focus{
      border-color: var(--primary1);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.5);
    }
    textarea{ resize:vertical; min-height:60px; }

    .button-row, .nav-row{
      margin-top:8px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .btn{
      padding:8px 16px;
      border-radius:999px;
      border:none;
      cursor:pointer;
      font-size:13px;
      font-weight:500;
      transition: background 0.18s ease, box-shadow 0.18s ease, transform 0.06s ease,
                  color 0.18s ease, border-color 0.18s ease;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .btn.small{ padding:6px 12px; font-size:12px; }

    .btn.primary{
      background: linear-gradient(135deg,var(--primary1),var(--primary2));
      color:#fff;
      box-shadow:0 6px 20px rgba(37,99,235,0.6);
    }
    .btn.primary:hover{
      transform: translateY(-1px);
      box-shadow:0 8px 26px rgba(37,99,235,0.8);
    }
    .btn.ghost{
      background:transparent;
      color: var(--btn-text-main);
      border:1px solid var(--btn-border-soft);
    }
    .btn.ghost:hover{ background: rgba(148,163,184,0.16); }
    .btn.danger{
      background:transparent;
      color: var(--danger-text);
      border:1px solid var(--danger-border);
    }
    .btn.danger:hover{ background: rgba(248,113,113,0.16); }

    .fs-btn{ margin-top:6px; }
    .msg{
      min-height:18px;
      font-size:13px;
      margin:6px 0 2px 0;
      color:#fca5a5;
    }

    .patient-info{
      background: rgba(15,23,42,0.75);
      border-radius:12px;
      padding:10px;
      margin-top:6px;
      border:1px solid rgba(148,163,184,0.4);
    }
    body[data-theme="light"] .patient-info{ background:#f9fafb; }
    body[data-theme="his"] .patient-info{ background:#020617; }

    .value-sm{
      font-size:14px;
      font-weight:500;
      color: var(--text-main);
    }
    .pill-dev{
      font-size:12px;
      font-weight:600;
      padding:2px 8px;
      border-radius:999px;
      background: rgba(59,130,246,0.2);
      border:1px solid rgba(59,130,246,0.6);
      color:#bfdbfe;
    }

    .new-patient h4{
      margin:10px 0 6px 0;
      font-size:14px;
      font-weight:600;
      color: var(--text-strong);
    }

    .item-row{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      margin-top:6px;
    }
    .label{ font-size:13px; color: var(--text-soft); }
    .value{ font-size:18px; font-weight:600; color: var(--text-main); }
    .value.time{ font-size:14px; font-weight:500; color:#d1d5db; }
    .value-pill{
      font-size:13px;
      font-weight:600;
      color:#ecfeff;
      background: linear-gradient(135deg,var(--accent-green1),var(--accent-green2));
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(22,163,74,0.7);
    }

    .card.history{ margin-top:16px; }
    .history-header h3{ margin-bottom:4px; }
    .history-sub{ margin:0; font-size:12px; color: var(--text-soft); }

    .history-table{
      width:100%;
      border-collapse:collapse;
      margin-top:10px;
      font-size:12px;
    }
    .history-table th, .history-table td{
      border-bottom:1px solid rgba(148,163,184,0.2);
      padding:6px 4px;
      text-align:left;
    }
    .history-table th{
      font-size:12px;
      color: var(--text-soft);
      font-weight:500;
    }
    .history-table td{ color: var(--text-main); }
    .history-table tr:hover td{ background: rgba(148,163,184,0.12); }
    .history-table .empty{ text-align:center; color: var(--text-soft); }

    .layout-grid{
      display:grid;
      grid-template-columns:1.1fr 0.9fr;
      gap:14px;
      margin-top:14px;
    }
    @media (max-width:768px){ .layout-grid{ grid-template-columns:1fr; } }
    @media (max-width:480px){ .card{ padding:14px 14px 12px; } }
  </style>
</head>

<body data-theme="dark">
<div class="bg-overlay"></div>

<div id="appWrapper">
  <div class="top-bar">
    <div class="logo-header">
      <img src="logo-kmutnb.png" class="logo-kmutnb" alt="KMUTNB">
      <img src="logo-nmu.png" class="logo-nmu" alt="NMU">
    </div>

    <div class="title-block">
      <h1>CPM Monitor</h1>
      <p>Continuous Passive Motion Dashboard</p>
    </div>

    <div class="theme-switcher">
      <button class="theme-btn active" data-theme-target="dark"><span class="dot"></span> Dark</button>
      <button class="theme-btn" data-theme-target="light"><span class="dot"></span> Light</button>
      <button class="theme-btn" data-theme-target="his"><span class="dot"></span> HIS</button>
    </div>
  </div>

  <!-- LOGIN -->
  <div id="loginBox" class="card">
    <h3>เข้าสู่ระบบ</h3>

    <label class="field-label">ชื่อผู้ใช้</label>
    <input id="username" type="text" placeholder="เช่น SS1">

    <label class="field-label">รหัสผ่าน</label>
    <input id="password" type="password" placeholder="รหัสผ่าน">

    <div class="button-row">
      <button id="loginBtn" class="btn primary">เข้าสู่ระบบ</button>
      <button id="goRegisterBtn" class="btn ghost small">สมัครสมาชิก</button>
    </div>

    <button id="fullscreenBtn" class="btn ghost small fs-btn">เต็มหน้าจอ</button>

    <p id="loginMsg" class="msg"></p>
  </div>

  <!-- REGISTER -->
  <div id="registerBox" class="card" style="display:none;">
    <h3>สมัครสมาชิก</h3>

    <label class="field-label">ชื่อผู้ใช้</label>
    <input id="regUsername" type="text" placeholder="กำหนดชื่อผู้ใช้ เช่น SS1">

    <label class="field-label">รหัสผ่าน</label>
    <input id="regPassword" type="password" placeholder="กำหนดรหัสผ่าน">

    <div class="button-row">
      <button id="registerSubmitBtn" class="btn primary">สมัครสมาชิก</button>
      <button id="backToLoginBtn" class="btn ghost small">กลับหน้าเข้าสู่ระบบ</button>
    </div>

    <p id="registerMsg" class="msg"></p>
  </div>

  <!-- MAIN -->
  <div id="mainPage" style="display:none;">
    <div class="card" id="userBox">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span>เข้าสู่ระบบเป็น: <strong id="currentUserLabel">-</strong></span>
        <button id="logoutBtn" class="btn danger small">ออกจากระบบ</button>
      </div>
    </div>

    <div class="layout-grid">
      <!-- ผู้ป่วย -->
      <div id="patientBox" class="card" style="display:none;">
        <h3>เลือกผู้ป่วย</h3>

        <div class="field-group">
          <label class="field-label">ผู้ป่วย</label>
          <select id="patientSelect">
            <option value="">— เลือกผู้ป่วย —</option>
          </select>
        </div>

        <div id="patientInfo" class="patient-info" style="display:none;">
          <div><span class="label">ชื่อ-สกุล:</span> <span id="pName" class="value-sm">-</span></div>
          <div><span class="label">รหัสผู้ป่วย (4 หลัก):</span> <span id="pHN" class="value-sm">-</span></div>
          <div><span class="label">Device ID:</span> <span id="pDevice" class="pill-dev">-</span></div>
          <div><span class="label">หมายเหตุ:</span> <span id="pNote" class="value-sm">-</span></div>
        </div>

        <hr class="divider">

        <button id="toggleNewPatientBtn" class="btn ghost small">+ สร้างข้อมูลผู้ป่วยใหม่</button>

        <div id="newPatientForm" class="new-patient" style="display:none;">
          <h4>เพิ่มผู้ป่วยใหม่</h4>

          <label class="field-label">ชื่อ-สกุล</label>
          <input id="newName" type="text" placeholder="เช่น นาย กายภาพ ตัวอย่าง">

          <label class="field-label">รหัสผู้ป่วย (4 หลัก)</label>
          <input id="newHN" type="text" maxlength="4" placeholder="เช่น 0123">

          <label class="field-label">Device ID ที่ใช้งาน (เช่น CPM01)</label>
          <input id="newDeviceId" type="text" placeholder="เช่น CPM01">

          <label class="field-label">หมายเหตุเพิ่มเติม</label>
          <textarea id="newNote" rows="2" placeholder="เช่น ข้อเท้าขวา post-op 3 วัน"></textarea>

          <button id="savePatientBtn" class="btn primary small">บันทึกผู้ป่วย</button>
          <p id="patientMsg" class="msg"></p>
        </div>

        <div class="button-row" style="margin-top:8px;">
          <button id="deletePatientBtn" class="btn danger small" style="display:none;">ลบผู้ป่วยนี้ (พร้อมประวัติ)</button>
        </div>
        <p id="deleteMsg" class="msg"></p>
      </div>

      <!-- Monitor -->
      <div id="monitorBox" class="card monitor" style="display:none;">
        <h3>สรุปผลล่าสุด (จากประวัติ)</h3>

        <div id="statusBox">
          <div class="item-row">
            <span class="label">สถานะ</span>
            <span class="value-pill" id="stateText">-</span>
          </div>
          <div class="item-row">
            <span class="label">มุมใช้งานครั้งล่าสุด</span>
            <span class="value" id="angleText">-</span>
          </div>
          <div class="item-row">
            <span class="label">ระยะเวลา</span>
            <span class="value" id="remText">-</span>
          </div>
          <div class="item-row">
            <span class="label">อัปเดตล่าสุด</span>
            <span class="value time" id="timeText">-</span>
          </div>
        </div>

        <div id="mainNavRow" class="nav-row" style="display:none;margin-top:12px;">
          <button id="refreshHistoryBtn" class="btn ghost small">รีเฟรชประวัติ</button>
          <button id="toHistoryBtn" class="btn ghost small" style="margin-left:auto;">หน้าถัดไป (ประวัติผู้ป่วย)</button>
        </div>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="historyPage" class="card history" style="display:none;">
    <div class="history-header">
      <h3>ประวัติการทำ CPM</h3>
      <p class="history-sub">แสดงประวัติของผู้ป่วยที่เลือก (จาก Firebase: /cpm_results/{patientId})</p>
    </div>

    <!-- ✅ Export buttons (เพิ่มใหม่) -->
    <div class="nav-row" style="margin-top:10px;">
      <button id="exportCsvBtn" class="btn primary small">Export CSV</button>
      <button id="copyCsvBtn" class="btn ghost small">Copy CSV</button>
      <button id="exportJsonBtn" class="btn ghost small">Export JSON</button>
      <span id="exportMsg" class="msg" style="margin-left:auto;min-height:0;"></span>
    </div>

    <table class="history-table">
      <thead>
        <tr>
          <th>วันที่ / เวลา</th>
          <th>มุมที่ใช้</th>
          <th>ระยะเวลา</th>
          <th>Device</th>
          <th>หมายเหตุ</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <tr><td colspan="5" class="empty">ยังไม่มีข้อมูล</td></tr>
      </tbody>
    </table>

    <div class="nav-row">
      <button id="backToMainBtn" class="btn ghost small">ย้อนกลับหน้าหลัก</button>
      <button id="backToLoginFromHistoryBtn" class="btn danger small">กลับหน้าเข้าสู่ระบบ</button>
    </div>
  </div>
</div>

<script>
  // =========================
  // CONFIG
  // =========================
  const FIREBASE_URL  = "https://ankle-cpm-default-rtdb.asia-southeast1.firebasedatabase.app";
  const FIREBASE_AUTH = null;

  function buildUrl(path) {
    let url = FIREBASE_URL + path;
    if (FIREBASE_AUTH) {
      const sep = url.includes("?") ? "&" : "?";
      url += sep + "auth=" + FIREBASE_AUTH;
    }
    return url;
  }

  // =========================
  // DOM refs
  // =========================
  const loginBox    = document.getElementById("loginBox");
  const registerBox = document.getElementById("registerBox");
  const mainPage    = document.getElementById("mainPage");
  const historyPage = document.getElementById("historyPage");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const loginBtn      = document.getElementById("loginBtn");
  const goRegisterBtn = document.getElementById("goRegisterBtn");
  const loginMsg      = document.getElementById("loginMsg");
  const fullscreenBtn = document.getElementById("fullscreenBtn");

  const regUsernameInput  = document.getElementById("regUsername");
  const regPasswordInput  = document.getElementById("regPassword");
  const registerSubmitBtn = document.getElementById("registerSubmitBtn");
  const backToLoginBtn    = document.getElementById("backToLoginBtn");
  const registerMsg       = document.getElementById("registerMsg");

  const logoutBtn        = document.getElementById("logoutBtn");
  const currentUserLabel = document.getElementById("currentUserLabel");

  const patientBox    = document.getElementById("patientBox");
  const monitorBox    = document.getElementById("monitorBox");
  const mainNavRow    = document.getElementById("mainNavRow");
  const patientSelect = document.getElementById("patientSelect");
  const patientInfo   = document.getElementById("patientInfo");
  const pNameEl       = document.getElementById("pName");
  const pHNEl         = document.getElementById("pHN");
  const pDeviceEl     = document.getElementById("pDevice");
  const pNoteEl       = document.getElementById("pNote");

  const toggleNewPatientBtn = document.getElementById("toggleNewPatientBtn");
  const newPatientForm      = document.getElementById("newPatientForm");
  const newNameInput        = document.getElementById("newName");
  const newHNInput          = document.getElementById("newHN");
  const newDeviceInput      = document.getElementById("newDeviceId");
  const newNoteInput        = document.getElementById("newNote");
  const savePatientBtn      = document.getElementById("savePatientBtn");
  const patientMsgEl        = document.getElementById("patientMsg");
  const deletePatientBtn    = document.getElementById("deletePatientBtn");
  const deleteMsgEl         = document.getElementById("deleteMsg");

  const stateEl  = document.getElementById("stateText");
  const angleEl  = document.getElementById("angleText");
  const remEl    = document.getElementById("remText");
  const timeEl   = document.getElementById("timeText");

  const historyBody               = document.getElementById("historyBody");
  const toHistoryBtn              = document.getElementById("toHistoryBtn");
  const backToMainBtn             = document.getElementById("backToMainBtn");
  const backToLoginFromHistoryBtn = document.getElementById("backToLoginFromHistoryBtn");
  const refreshHistoryBtn         = document.getElementById("refreshHistoryBtn");

  // ✅ Export refs
  const exportCsvBtn  = document.getElementById("exportCsvBtn");
  const exportJsonBtn = document.getElementById("exportJsonBtn");
  const copyCsvBtn    = document.getElementById("copyCsvBtn");
  const exportMsg     = document.getElementById("exportMsg");

  let currentUserId    = null;
  let patientMap       = {};
  let currentPatientId = null;

  // ✅ เก็บข้อมูล history ล่าสุดเพื่อ export
  let lastHistoryRows = [];

  // =========================
  // helpers
  // =========================
  function formatMMSS(sec) {
    sec = Math.max(0, sec | 0);
    const m  = Math.floor(sec / 60);
    const s  = sec % 60;
    const mm = (m < 10 ? "0" : "") + m;
    const ss = (s < 10 ? "0" : "") + s;
    return `${mm}:${ss}`;
  }

  function formatTimeFromSeconds(tsSec) {
    if (!tsSec) return "-";
    const d = new Date(tsSec * 1000);
    const pad = (n)=>n.toString().padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()+543} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }

  function safeFilePart(s){
    return String(s || "").replace(/[^\w\-]+/g, "_").slice(0, 60);
  }

  function clearMonitor(){
    stateEl.textContent="-";
    angleEl.textContent="-";
    remEl.textContent="-";
    timeEl.textContent="-";
  }

  function clearHistoryTable(){
    historyBody.innerHTML = `<tr><td colspan="5" class="empty">ยังไม่มีข้อมูล</td></tr>`;
    lastHistoryRows = [];
    exportMsg.textContent = "";
  }

  function showLoginUI(){
    loginBox.style.display    = "block";
    registerBox.style.display = "none";
    mainPage.style.display    = "none";
    historyPage.style.display = "none";
    logoutBtn.style.display   = "none";

    currentUserId = null;
    currentUserLabel.textContent = "-";
    patientMap = {};
    currentPatientId = null;
    patientSelect.innerHTML = `<option value="">— เลือกผู้ป่วย —</option>`;
    patientInfo.style.display = "none";
    deletePatientBtn.style.display = "none";
    clearMonitor();
    clearHistoryTable();
    loginMsg.textContent    = "";
    registerMsg.textContent = "";
  }

  function showRegisterUI(){
    loginBox.style.display    = "none";
    registerBox.style.display = "block";
    mainPage.style.display    = "none";
    historyPage.style.display = "none";
    registerMsg.textContent   = "";
  }

  function showMainUI(){
    loginBox.style.display    = "none";
    registerBox.style.display = "none";
    mainPage.style.display    = "block";
    historyPage.style.display = "none";
    patientBox.style.display  = "block";
    monitorBox.style.display  = "block";
    mainNavRow.style.display  = "block";
    logoutBtn.style.display   = "inline-flex";
    currentUserLabel.textContent = currentUserId || "-";
  }

  fullscreenBtn.addEventListener("click",()=>{
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen().catch(console.error);
    }else{
      document.exitFullscreen();
    }
  });

  // =========================
  // Auth
  // =========================
  async function registerUser(username,password){
    const u = username.trim();
    const p = password.trim();
    if(!u || !p){
      registerMsg.textContent="กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
      registerMsg.style.color="yellow";
      return;
    }
    try{
      const url = buildUrl("/users/"+encodeURIComponent(u)+".json");
      const res = await fetch(url);
      if(!res.ok){
        registerMsg.textContent="อ่านข้อมูลจาก Firebase ไม่ได้ ("+res.status+")";
        registerMsg.style.color="red";
        return;
      }
      const existing = await res.json();

      if(existing && typeof existing==="object" && existing.password!==undefined){
        registerMsg.textContent="มีผู้ใช้นี้อยู่แล้ว กรุณาใช้ชื่ออื่น";
        registerMsg.style.color="red";
        return;
      }

      const payload={password:p,createdAt:Date.now()};
      const putRes = await fetch(url,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(!putRes.ok) throw new Error("HTTP "+putRes.status);

      registerMsg.textContent="สมัครสมาชิกสำเร็จ กำลังกลับหน้าเข้าสู่ระบบ...";
      registerMsg.style.color="lightgreen";
      setTimeout(showLoginUI,1500);
    }catch(err){
      registerMsg.textContent="สมัครสมาชิกไม่สำเร็จ: "+err;
      registerMsg.style.color="red";
    }
  }

  async function loginUser(username,password){
    const u = username.trim();
    const p = password.trim();
    if(!u || !p){
      loginMsg.textContent="กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
      loginMsg.style.color="yellow";
      return;
    }
    try{
      const url = buildUrl("/users/"+encodeURIComponent(u)+".json");
      const res = await fetch(url);
      if(!res.ok){
        loginMsg.textContent="อ่านข้อมูลผู้ใช้ไม่ได้ ("+res.status+")";
        loginMsg.style.color="red";
        return;
      }
      const data = await res.json();

      if(!data || typeof data!=="object" || data.password===undefined){
        loginMsg.textContent="ไม่พบชื่อผู้ใช้นี้";
        loginMsg.style.color="red";
        return;
      }
      if(data.password!==p){
        loginMsg.textContent="รหัสผ่านไม่ถูกต้อง";
        loginMsg.style.color="red";
        return;
      }

      currentUserId = u;
      currentUserLabel.textContent = u;
      loginMsg.textContent = "";
      showMainUI();
      await loadPatientsForCurrentUser();
    }catch(err){
      loginMsg.textContent="เข้าสู่ระบบไม่สำเร็จ: "+err;
      loginMsg.style.color="red";
    }
  }

  function logout(){
    usernameInput.value="";
    passwordInput.value="";
    showLoginUI();
  }

  loginBtn.addEventListener("click",e=>{ e.preventDefault(); loginUser(usernameInput.value,passwordInput.value); });
  goRegisterBtn.addEventListener("click",e=>{ e.preventDefault(); showRegisterUI(); });
  registerSubmitBtn.addEventListener("click",e=>{ e.preventDefault(); registerUser(regUsernameInput.value,regPasswordInput.value); });
  backToLoginBtn.addEventListener("click",e=>{ e.preventDefault(); showLoginUI(); });
  logoutBtn.addEventListener("click",e=>{ e.preventDefault(); logout(); });

  // =========================
  // Patients (/patients) แยกตาม ownerId
  // =========================
  async function loadPatientsForCurrentUser(){
    patientMap={};
    patientSelect.innerHTML=`<option value="">— เลือกผู้ป่วย —</option>`;
    patientInfo.style.display="none";
    deletePatientBtn.style.display="none";
    clearHistoryTable();
    clearMonitor();
    if(!currentUserId) return;

    try{
      const url = buildUrl("/patients.json");
      const res = await fetch(url);
      const data = await res.json();
      if(!data) return;

      Object.keys(data).forEach(pid=>{
        const p=data[pid];
        if(!p) return;
        if(String(p.ownerId||"") !== String(currentUserId)) return;

        patientMap[pid]=p;

        const opt=document.createElement("option");
        const fullname=(p.name||"")+(p.lastname?(" "+p.lastname):"");
        opt.value=pid;
        opt.textContent=`${fullname} (${pid})`;
        patientSelect.appendChild(opt);
      });
    }catch(err){
      console.error("loadPatientsForCurrentUser error:",err);
    }
  }

  toggleNewPatientBtn.addEventListener("click",()=>{
    newPatientForm.style.display = (newPatientForm.style.display==="block") ? "none" : "block";
  });

  savePatientBtn.addEventListener("click",async()=>{
    patientMsgEl.textContent="";
    deleteMsgEl.textContent="";
    if(!currentUserId){
      patientMsgEl.textContent="กรุณาเข้าสู่ระบบก่อน";
      patientMsgEl.style.color="red";
      return;
    }

    const name=newNameInput.value.trim();
    const id=newHNInput.value.trim();
    const deviceId=newDeviceInput.value.trim();
    const note=newNoteInput.value.trim();

    if(!name){
      patientMsgEl.textContent="กรุณากรอกชื่อ-สกุล";
      patientMsgEl.style.color="red"; return;
    }
    if(id.length!==4 || !/^\d{4}$/.test(id)){
      patientMsgEl.textContent="รหัสผู้ป่วยต้องเป็นตัวเลข 4 หลัก (เช่น 0123)";
      patientMsgEl.style.color="red"; return;
    }

    const payload={
      patientId:id,
      name,
      lastname:"",
      deviceId:deviceId||"",
      note:note||"",
      ownerId:currentUserId,
      createdAt:Date.now()
    };

    try{
      const url=buildUrl("/patients/"+encodeURIComponent(id)+".json");
      const res=await fetch(url,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("HTTP "+res.status);

      patientMsgEl.textContent="บันทึกข้อมูลผู้ป่วยเรียบร้อย";
      patientMsgEl.style.color="lightgreen";

      newNameInput.value="";
      newHNInput.value="";
      newDeviceInput.value="";
      newNoteInput.value="";
      newPatientForm.style.display="none";

      await loadPatientsForCurrentUser();
      patientSelect.value=id;
      onPatientSelected(id);
    }catch(err){
      patientMsgEl.textContent="บันทึกไม่สำเร็จ: "+err;
      patientMsgEl.style.color="red";
    }
  });

  deletePatientBtn.addEventListener("click",async()=>{
    deleteMsgEl.textContent="";
    if(!currentUserId){
      deleteMsgEl.textContent="กรุณาเข้าสู่ระบบก่อน";
      deleteMsgEl.style.color="red"; return;
    }
    if(!currentPatientId || !patientMap[currentPatientId]){
      deleteMsgEl.textContent="กรุณาเลือกผู้ป่วยก่อนลบ";
      deleteMsgEl.style.color="yellow"; return;
    }

    const ok=window.confirm("ยืนยันลบผู้ป่วยรหัส "+currentPatientId+" และประวัติทั้งหมด?");
    if(!ok) return;

    try{
      await fetch(buildUrl("/patients/"+encodeURIComponent(currentPatientId)+".json"), {method:"DELETE"});
      await fetch(buildUrl("/cpm_results/" + encodeURIComponent(currentPatientId) + ".json"), {method:"DELETE"});

      deleteMsgEl.textContent="ลบผู้ป่วยและประวัติเรียบร้อย";
      deleteMsgEl.style.color="lightgreen";

      currentPatientId=null;
      patientInfo.style.display="none";
      deletePatientBtn.style.display="none";
      patientSelect.value="";
      clearMonitor();
      clearHistoryTable();
      await loadPatientsForCurrentUser();
    }catch(err){
      deleteMsgEl.textContent="ลบไม่สำเร็จ: "+err;
      deleteMsgEl.style.color="red";
    }
  });

  patientSelect.addEventListener("change",()=>{ onPatientSelected(patientSelect.value); });

  function onPatientSelected(id){
    deleteMsgEl.textContent="";
    if(!id || !patientMap[id]){
      currentPatientId=null;
      patientInfo.style.display="none";
      deletePatientBtn.style.display="none";
      clearMonitor();
      clearHistoryTable();
      return;
    }

    currentPatientId=id;
    const p=patientMap[id];
    pNameEl.textContent=(p.name||"")+(p.lastname?(" "+p.lastname):"");
    pHNEl.textContent=p.patientId||id;
    pDeviceEl.textContent=p.deviceId||"-";
    pNoteEl.textContent=p.note||"-";
    patientInfo.style.display="block";
    deletePatientBtn.style.display="inline-flex";

    loadHistoryForPatient(currentPatientId);
  }

  // =========================
  // Export helpers (เพิ่มใหม่)
  // =========================
  function downloadTextFile(filename, text, mime="text/plain;charset=utf-8"){
    const blob = new Blob([text], {type: mime});
    const url  = URL.createObjectURL(blob);
    const a    = document.createElement("a");
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }

  function csvEscape(v){
    const s = (v == null) ? "" : String(v);
    // escape double quotes
    const esc = s.replace(/"/g, '""');
    // wrap if needed
    if (/[",\n]/.test(esc)) return `"${esc}"`;
    return esc;
  }

  function buildCsvFromRows(rows){
    const header = [
      "patientId","deviceId",
      "endLocal","endTsUnix","endTsMs",
      "angle1","angle2",
      "workTimeSec","workTimeMMSS",
      "ownerId"
    ];

    const lines = [];
    lines.push(header.join(","));

    rows.forEach(r=>{
      const row = [
        r.patientId, r.deviceId,
        r.endLocal, r.endTsUnix, r.endTsMs,
        r.angle1, r.angle2,
        r.workTimeSec, r.workTimeMMSS,
        r.ownerId
      ].map(csvEscape);
      lines.push(row.join(","));
    });

    return lines.join("\n");
  }

  async function copyToClipboard(text){
    // ใช้ Clipboard API ถ้าได้
    if (navigator.clipboard && navigator.clipboard.writeText){
      await navigator.clipboard.writeText(text);
      return true;
    }
    // fallback: textarea
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position="fixed";
    ta.style.left="-9999px";
    document.body.appendChild(ta);
    ta.select();
    const ok = document.execCommand("copy");
    ta.remove();
    return ok;
  }

  function setExportMsg(text, color="lightgreen"){
    exportMsg.textContent = text || "";
    exportMsg.style.color = color;
    if (text){
      setTimeout(()=>{ exportMsg.textContent=""; }, 2500);
    }
  }

  exportCsvBtn.addEventListener("click", ()=>{
    if(!currentPatientId || !lastHistoryRows.length){
      setExportMsg("ไม่มีข้อมูลให้ Export", "yellow");
      return;
    }
    const filename = `CPM_${safeFilePart(currentPatientId)}_history.csv`;
    const csv = buildCsvFromRows(lastHistoryRows);
    downloadTextFile(filename, csv, "text/csv;charset=utf-8");
    setExportMsg("ดาวน์โหลด CSV แล้ว");
  });

  exportJsonBtn.addEventListener("click", ()=>{
    if(!currentPatientId || !lastHistoryRows.length){
      setExportMsg("ไม่มีข้อมูลให้ Export", "yellow");
      return;
    }
    const filename = `CPM_${safeFilePart(currentPatientId)}_history.json`;
    const json = JSON.stringify(lastHistoryRows, null, 2);
    downloadTextFile(filename, json, "application/json;charset=utf-8");
    setExportMsg("ดาวน์โหลด JSON แล้ว");
  });

  copyCsvBtn.addEventListener("click", async ()=>{
    if(!currentPatientId || !lastHistoryRows.length){
      setExportMsg("ไม่มีข้อมูลให้ Copy", "yellow");
      return;
    }
    try{
      const csv = buildCsvFromRows(lastHistoryRows);
      const ok = await copyToClipboard(csv);
      setExportMsg(ok ? "คัดลอก CSV แล้ว" : "คัดลอกไม่สำเร็จ", ok ? "lightgreen" : "red");
    }catch(e){
      setExportMsg("คัดลอกไม่สำเร็จ", "red");
    }
  });

  // =========================
  // History: อ่าน /cpm_results/{patientId}
  // =========================
  async function loadHistoryForPatient(patientId) {
    clearHistoryTable();
    clearMonitor();
    if (!patientId) return;

    try {
      const url = buildUrl("/cpm_results/" + encodeURIComponent(patientId) + ".json");
      const res = await fetch(url);
      if (!res.ok) throw new Error("HTTP " + res.status);
      const data = await res.json();

      if (!data || typeof data !== "object") {
        clearHistoryTable();
        return;
      }

      const rows = [];
      for (const pushKey in data) {
        const item = data[pushKey];
        if (!item) continue;

        let tsSec = 0;
        if (item.endTsUnix != null) tsSec = Number(item.endTsUnix) || 0;
        else if (item.endTsMs != null) tsSec = Math.floor((Number(item.endTsMs) || 0) / 1000);

        rows.push({ _key: pushKey, ...item, _ts: tsSec });
      }

      if (rows.length === 0) {
        clearHistoryTable();
        return;
      }

      rows.sort((a, b) => (b._ts || 0) - (a._ts || 0));

      // ✅ เก็บไว้ export (ตัด field ภายในบางตัวได้ตามต้องการ)
      lastHistoryRows = rows.map(r => ({
        patientId: r.patientId ?? String(patientId),
        deviceId: r.deviceId ?? "",
        endLocal: r.endLocal ?? "",
        endTsUnix: r.endTsUnix ?? (r._ts || 0),
        endTsMs: r.endTsMs ?? ((r._ts||0) ? (r._ts*1000) : 0),
        angle1: r.angle1 ?? "",
        angle2: r.angle2 ?? "",
        workTimeSec: r.workTimeSec ?? "",
        workTimeMMSS: r.workTimeMMSS ?? "",
        ownerId: r.ownerId ?? ""
      }));

      historyBody.innerHTML = "";

      rows.forEach((r) => {
        const tr = document.createElement("tr");

        const tsDisp = (r._ts) ? formatTimeFromSeconds(r._ts) : (r.endLocal || "-");
        const angleDisp = (r.angle1 != null && r.angle2 != null) ? `${r.angle1}° - ${r.angle2}°` : "-";

        const timeDisp =
          (r.workTimeSec != null)
            ? `${r.workTimeSec} วินาที (${formatMMSS(r.workTimeSec)})`
            : (r.workTimeMMSS ? `${r.workTimeMMSS} (mm:ss)` : "-");

        const devDisp  = r.deviceId || "ESP32-CPM";
        const noteDisp = r.note || "";

        tr.innerHTML = `
          <td>${tsDisp}</td>
          <td>${angleDisp}</td>
          <td>${timeDisp}</td>
          <td>${devDisp}</td>
          <td>${noteDisp}</td>
        `;
        historyBody.appendChild(tr);
      });

      const latest = rows[0];
      stateEl.textContent = "FINISHED";
      angleEl.textContent = (latest.angle1 != null && latest.angle2 != null) ? `${latest.angle1}° - ${latest.angle2}°` : "-";
      remEl.textContent =
        (latest.workTimeSec != null)
          ? `${latest.workTimeSec} วินาที (${formatMMSS(latest.workTimeSec)})`
          : (latest.workTimeMMSS ? latest.workTimeMMSS : "-");
      timeEl.textContent  = (latest._ts) ? formatTimeFromSeconds(latest._ts) : (latest.endLocal || "-");

    } catch (err) {
      console.error("loadHistoryForPatient error:", err);
      clearHistoryTable();
    }
  }

  // =========================
  // Navigation
  // =========================
  toHistoryBtn.addEventListener("click",()=>{
    historyPage.style.display="block";
    mainPage.style.display="none";
  });
  backToMainBtn.addEventListener("click",()=>{
    historyPage.style.display="none";
    mainPage.style.display="block";
  });
  backToLoginFromHistoryBtn.addEventListener("click",()=>{
    showLoginUI();
  });

  refreshHistoryBtn.addEventListener("click", ()=>{
    if(currentPatientId) loadHistoryForPatient(currentPatientId);
  });

  document.addEventListener("DOMContentLoaded",showLoginUI);

  // theme switch
  (function () {
    const body = document.body;
    const btns = document.querySelectorAll(".theme-btn");
    btns.forEach((btn)=>{
      btn.addEventListener("click",()=>{
        const theme = btn.getAttribute("data-theme-target");
        body.setAttribute("data-theme", theme || "dark");
        btns.forEach(b=>b.classList.remove("active"));
        btn.classList.add("active");
      });
    });
  })();
</script>
</body>
</html>

