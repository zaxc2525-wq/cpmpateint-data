<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>CPM Monitor</title>

  <!-- ‡∏ñ‡πâ‡∏≤ repo ‡∏ö‡∏ô GitHub Pages ‡∏ä‡∏∑‡πà‡∏≠ cpmpateint-data -->
  <base href="/cpmpateint-data/">

  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div class="bg-overlay"></div>

  <div id="appWrapper">
    <!-- LOGO -->
    <div class="logo-block">
      <div class="logo-circle">CPM</div>
      <div class="logo-text">
        <h1>CPM Monitor</h1>
        <p>Continuous Passive Motion Dashboard</p>
      </div>
    </div>

    <!-- ========== LOGIN PAGE ========== -->
    <div id="loginBox" class="card">
      <h3>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</h3>

      <label class="field-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
      <input id="username" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô SS1">

      <label class="field-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <input id="password" type="password" placeholder="‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">

      <div class="button-row">
        <button id="loginBtn" class="btn primary">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
        <button id="goRegisterBtn" class="btn ghost small">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
      </div>

      <button id="fullscreenBtn" class="btn ghost small fs-btn">
        ‡πÄ‡∏ï‡πá‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏≠
      </button>

      <p id="loginMsg" class="msg"></p>
    </div>

    <!-- ========== REGISTER PAGE (‡πÅ‡∏¢‡∏Å‡∏ï‡πà‡∏≤‡∏á‡∏´‡∏≤‡∏Å) ========== -->
    <div id="registerBox" class="card" style="display:none;">
      <h3>‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</h3>

      <label class="field-label">‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ</label>
      <input id="regUsername" type="text" placeholder="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ ‡πÄ‡∏ä‡πà‡∏ô SS1">

      <label class="field-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô</label>
      <input id="regPassword" type="password" placeholder="‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô">

      <div class="button-row">
        <button id="registerSubmitBtn" class="btn primary">‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å</button>
        <button id="backToLoginBtn" class="btn ghost small">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>

      <p id="registerMsg" class="msg"></p>
    </div>

    <!-- ========== MAIN PAGE (‡∏´‡∏•‡∏±‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡πÅ‡∏•‡πâ‡∏ß) ========== -->
    <div id="mainPage" style="display:none;">
      <!-- user bar -->
      <div class="card" id="userBox">
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <span>‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô: <strong id="currentUserLabel">-</strong></span>
          <button id="logoutBtn" class="btn danger small">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</button>
        </div>
      </div>

      <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ -->
      <div id="patientBox" class="card" style="display:none;">
        <h3>‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</h3>

        <div class="field-group">
          <label class="field-label">‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</label>
          <select id="patientSelect">
            <option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‚Äî</option>
          </select>
        </div>

        <div id="patientInfo" class="patient-info" style="display:none;">
          <div><span class="label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•:</span> <span id="pName" class="value-sm">-</span></div>
          <div><span class="label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (4 ‡∏´‡∏•‡∏±‡∏Å):</span> <span id="pHN" class="value-sm">-</span></div>
          <div><span class="label">Device ID:</span> <span id="pDevice" class="pill-dev">-</span></div>
          <div><span class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏:</span> <span id="pNote" class="value-sm">-</span></div>
        </div>

        <hr class="divider">

        <button id="toggleNewPatientBtn" class="btn ghost small">
          + ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà
        </button>

        <div id="newPatientForm" class="new-patient" style="display:none;">
          <h4>‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÉ‡∏´‡∏°‡πà</h4>

          <label class="field-label">‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•</label>
          <input id="newName" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏ô‡∏≤‡∏¢ ‡∏Å‡∏≤‡∏¢‡∏†‡∏≤‡∏û ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á">

          <label class="field-label">‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ (4 ‡∏´‡∏•‡∏±‡∏Å)</label>
          <input id="newHN" type="text" maxlength="4" placeholder="‡πÄ‡∏ä‡πà‡∏ô 0123">

          <label class="field-label">Device ID ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (‡πÄ‡∏ä‡πà‡∏ô CPM01)</label>
          <input id="newDeviceId" type="text" placeholder="‡πÄ‡∏ä‡πà‡∏ô CPM01">

          <label class="field-label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°</label>
          <textarea id="newNote" rows="2" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ç‡πâ‡∏≠‡πÄ‡∏ó‡πâ‡∏≤‡∏Ç‡∏ß‡∏≤ post-op 3 ‡∏ß‡∏±‡∏ô"></textarea>

          <button id="savePatientBtn" class="btn primary small">‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢</button>
          <p id="patientMsg" class="msg"></p>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ -->
        <div class="button-row" style="margin-top:8px;">
          <button id="deletePatientBtn" class="btn danger small" style="display:none;">
            ‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ô‡∏µ‡πâ (‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥)
          </button>
        </div>
        <p id="deleteMsg" class="msg"></p>
      </div>

      <!-- Monitor CPM -->
      <div id="monitorBox" class="card monitor" style="display:none;">
        <h3>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á CPM</h3>
        <div id="statusBox">
          <div class="item-row">
            <span class="label">‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</span>
            <span class="value-pill" id="stateText">-</span>
          </div>

          <div class="item-row">
            <span class="label">‡∏°‡∏∏‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
            <span class="value" id="angleText">-</span>
          </div>

          <div class="item-row">
            <span class="label">‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</span>
            <span class="value" id="remText">-</span>
          </div>

          <div class="item-row">
            <span class="label">‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</span>
            <span class="value time" id="timeText">-</span>
          </div>
        </div>
      </div>

      <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÑ‡∏õ History -->
      <div id="mainNavRow" class="nav-row" style="display:none;">
        <button id="toHistoryBtn" class="btn ghost small">‡∏´‡∏ô‡πâ‡∏≤‡∏ñ‡∏±‡∏î‡πÑ‡∏õ (‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢)</button>
      </div>
    </div>

    <!-- ========== HISTORY PAGE ========== -->
    <div id="historyPage" class="card history" style="display:none;">
      <div class="history-header">
        <h3>‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏ó‡∏≥ CPM</h3>
        <p class="history-sub">‡πÅ‡∏™‡∏î‡∏á‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏à‡∏≤‡∏Å Firebase)</p>
      </div>

      <table class="history-table">
        <thead>
          <tr>
            <th>‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà / ‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>‡∏°‡∏∏‡∏°‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ</th>
            <th>‡∏£‡∏∞‡∏¢‡∏∞‡πÄ‡∏ß‡∏•‡∏≤</th>
            <th>Device</th>
            <th>‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</th>
          </tr>
        </thead>
        <tbody id="historyBody">
          <tr>
            <td colspan="5" class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
          </tr>
        </tbody>
      </table>

      <div class="nav-row">
        <button id="backToMainBtn" class="btn ghost small">‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡∏´‡∏•‡∏±‡∏Å</button>
        <button id="backToLoginFromHistoryBtn" class="btn danger small">‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
      </div>
    </div>
  </div>

  <script>
    // ==========================
    // Firebase Realtime DB (REST)
    // ==========================
    const FIREBASE_URL  = "https://ankle-cpm-default-rtdb.asia-southeast1.firebasedatabase.app";
    const FIREBASE_AUTH = null; // ‡∏ñ‡πâ‡∏≤‡πÉ‡∏ä‡πâ token ‡πÉ‡∏™‡πà string ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢

    function buildUrl(path) {
      let url = FIREBASE_URL + path;
      if (FIREBASE_AUTH) {
        const sep = url.includes("?") ? "&" : "?";
        url += sep + "auth=" + FIREBASE_AUTH;
      }
      return url;
    }

    // ==========================
    // DOM elements
    // ==========================
    const loginBox    = document.getElementById("loginBox");
    const registerBox = document.getElementById("registerBox");
    const mainPage    = document.getElementById("mainPage");
    const historyPage = document.getElementById("historyPage");

    // login
    const usernameInput = document.getElementById("username");
    const passwordInput = document.getElementById("password");
    const loginBtn      = document.getElementById("loginBtn");
    const goRegisterBtn = document.getElementById("goRegisterBtn");
    const loginMsg      = document.getElementById("loginMsg");
    const fullscreenBtn = document.getElementById("fullscreenBtn");

    // register
    const regUsernameInput  = document.getElementById("regUsername");
    const regPasswordInput  = document.getElementById("regPassword");
    const registerSubmitBtn = document.getElementById("registerSubmitBtn");
    const backToLoginBtn    = document.getElementById("backToLoginBtn");
    const registerMsg       = document.getElementById("registerMsg");

    // main user bar
    const logoutBtn        = document.getElementById("logoutBtn");
    const currentUserLabel = document.getElementById("currentUserLabel");

    // patient area
    const patientBox   = document.getElementById("patientBox");
    const patientSelect= document.getElementById("patientSelect");
    const patientInfo  = document.getElementById("patientInfo");
    const pNameEl      = document.getElementById("pName");
    const pHNEl        = document.getElementById("pHN");
    const pDeviceEl    = document.getElementById("pDevice");
    const pNoteEl      = document.getElementById("pNote");

    const toggleNewPatientBtn = document.getElementById("toggleNewPatientBtn");
    const newPatientForm      = document.getElementById("newPatientForm");
    const newNameInput        = document.getElementById("newName");
    const newHNInput          = document.getElementById("newHN");
    const newDeviceInput      = document.getElementById("newDeviceId");
    const newNoteInput        = document.getElementById("newNote");
    const savePatientBtn      = document.getElementById("savePatientBtn");
    const patientMsgEl        = document.getElementById("patientMsg");

    const deletePatientBtn    = document.getElementById("deletePatientBtn");
    const deleteMsgEl         = document.getElementById("deleteMsg");

    // monitor
    const monitorBox = document.getElementById("monitorBox");
    const mainNavRow = document.getElementById("mainNavRow");
    const stateEl    = document.getElementById("stateText");
    const angleEl    = document.getElementById("angleText");
    const remEl      = document.getElementById("remText");
    const timeEl     = document.getElementById("timeText");

    // history
    const historyBody        = document.getElementById("historyBody");
    const toHistoryBtn       = document.getElementById("toHistoryBtn");
    const backToMainBtn      = document.getElementById("backToMainBtn");
    const backToLoginFromHistoryBtn = document.getElementById("backToLoginFromHistoryBtn");

    // ==========================
    // State
    // ==========================
    let currentUserId    = null;
    let patientMap       = {};
    let currentPatientId = null;

    // ==========================
    // Helpers
    // ==========================
    function formatMMSS(sec) {
      sec = Math.max(0, sec | 0);
      const m  = Math.floor(sec / 60);
      const s  = sec % 60;
      const mm = (m < 10 ? "0" : "") + m;
      const ss = (s < 10 ? "0" : "") + s;
      return `${mm}:${ss}`;
    }

    function formatTimeFromSeconds(tsSec) {
      if (!tsSec) return "-";
      const d = new Date(tsSec * 1000);
      const pad = (n) => n.toString().padStart(2, "0");
      const dd  = pad(d.getDate());
      const mm  = pad(d.getMonth() + 1);
      const yy  = d.getFullYear() + 543;
      const hh  = pad(d.getHours());
      const mi  = pad(d.getMinutes());
      const ss  = pad(d.getSeconds());
      return `${dd}/${mm}/${yy} ${hh}:${mi}:${ss}`;
    }

    function clearMonitor() {
      stateEl.textContent = "-";
      angleEl.textContent = "-";
      remEl.textContent   = "-";
      timeEl.textContent  = "-";
    }

    function clearHistoryTable() {
      historyBody.innerHTML = `
        <tr>
          <td colspan="5" class="empty">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</td>
        </tr>
      `;
    }

    // ==========================
    // UI switch
    // ==========================
    function showLoginUI() {
      loginBox.style.display    = "block";
      registerBox.style.display = "none";
      mainPage.style.display    = "none";
      historyPage.style.display = "none";
      logoutBtn.style.display   = "none";

      currentUserId             = null;
      currentUserLabel.textContent = "-";
      patientMap       = {};
      currentPatientId = null;

      patientSelect.innerHTML   = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‚Äî</option>`;
      patientInfo.style.display = "none";
      deletePatientBtn.style.display = "none";
      clearMonitor();
      clearHistoryTable();

      loginMsg.textContent    = "";
      registerMsg.textContent = "";
    }

    function showRegisterUI() {
      loginBox.style.display    = "none";
      registerBox.style.display = "block";
      mainPage.style.display    = "none";
      historyPage.style.display = "none";

      registerMsg.textContent  = "";
      regUsernameInput.value   = "";
      regPasswordInput.value   = "";
    }

    function showMainUI() {
      loginBox.style.display    = "none";
      registerBox.style.display = "none";
      mainPage.style.display    = "block";
      historyPage.style.display = "none";

      patientBox.style.display  = "block";
      monitorBox.style.display  = "block";
      mainNavRow.style.display  = "block";
      logoutBtn.style.display   = "inline-block";

      currentUserLabel.textContent = currentUserId || "-";
    }

    fullscreenBtn.addEventListener("click", () => {
      if (!document.fullscreenElement) {
        document.documentElement.requestFullscreen().catch(console.error);
      } else {
        document.exitFullscreen();
      }
    });

    // ==========================
    // USER: Register / Login
    // ==========================
    async function loginUser(username, password) {
  const u = username.trim();
  const p = password.trim();

  if (!u || !p) {
    loginMsg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
    loginMsg.style.color = "yellow";
    return;
  }

  try {
    const url = buildUrl("/users/" + encodeURIComponent(u) + ".json");
    const res = await fetch(url);

    if (!res.ok) {
      loginMsg.textContent = "‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (" + res.status + ")";
      loginMsg.style.color = "red";
      return;
    }

    const data = await res.json();
    console.log("login user data =", data);

    // ‡πÑ‡∏°‡πà‡∏°‡∏µ user ‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏µ‡πâ‡πÄ‡∏•‡∏¢
    if (!data || typeof data !== "object" || data.password === undefined) {
      loginMsg.textContent = "‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ";
      loginMsg.style.color = "red";
      return;
    }

    // password ‡πÑ‡∏°‡πà‡∏ï‡∏£‡∏á
    if (data.password !== p) {
      loginMsg.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á";
      loginMsg.style.color = "red";
      return;
    }

    // ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
    currentUserId = u;
    currentUserLabel.textContent = u;
    loginMsg.textContent = "";

    showMainUI();
    await loadPatientsForCurrentUser();
  } catch (err) {
    console.error("loginUser error:", err);
    loginMsg.textContent = "‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err;
    loginMsg.style.color = "red";
  }
}


async function registerUser(username, password) {
  const u = username.trim();
  const p = password.trim();

  if (!u || !p) {
    registerMsg.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡∏∞‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô";
    registerMsg.style.color = "yellow";
    return;
  }

  try {
    const url = buildUrl("/users/" + encodeURIComponent(u) + ".json");
    const res = await fetch(url);

    if (!res.ok) {
      // ‡∏ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÉ‡∏´‡πâ‡πÅ‡∏™‡∏î‡∏á error ‡∏ï‡∏£‡∏á ‡πÜ
      registerMsg.textContent = "‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏≤‡∏Å Firebase ‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ (" + res.status + ")";
      registerMsg.style.color = "red";
      return;
    }

    const existing = await res.json();
    console.log("existing user data =", existing);

    // üëá ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤ "‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß" ‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏ü‡∏¥‡∏•‡∏î‡πå password ‡∏à‡∏£‡∏¥‡∏á ‡πÜ
    if (existing && typeof existing === "object" && existing.password !== undefined) {
      registerMsg.textContent = "‡∏°‡∏µ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô";
      registerMsg.style.color = "red";
      return;
    }

    // -------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÉ‡∏´‡∏°‡πà --------
    const payload = {
      password: p,          // (‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏£‡∏¥‡∏á‡∏Ñ‡∏ß‡∏£ hash ‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô)
      createdAt: Date.now()
    };

    const putRes = await fetch(url, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(payload)
    });

    if (!putRes.ok) {
      throw new Error("HTTP " + putRes.status);
    }

    registerMsg.textContent = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö...";
    registerMsg.style.color = "lightgreen";

    setTimeout(() => {
      showLoginUI();
    }, 1500);
  } catch (err) {
    console.error("registerUser error:", err);
    registerMsg.textContent = "‡∏™‡∏°‡∏±‡∏Ñ‡∏£‡∏™‡∏°‡∏≤‡∏ä‡∏¥‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err;
    registerMsg.style.color = "red";
  }
}


    function logout() {
      usernameInput.value = "";
      passwordInput.value = "";
      showLoginUI();
    }

    // ==========================
    // USER: event handlers
    // ==========================
    loginBtn.addEventListener("click", (e) => {
      e.preventDefault();
      loginUser(usernameInput.value, passwordInput.value);
    });

    goRegisterBtn.addEventListener("click", (e) => {
      e.preventDefault();
      showRegisterUI();
    });

    registerSubmitBtn.addEventListener("click", (e) => {
      e.preventDefault();
      registerUser(regUsernameInput.value, regPasswordInput.value);
    });

    backToLoginBtn.addEventListener("click", (e) => {
      e.preventDefault();
      showLoginUI();
    });

    logoutBtn.addEventListener("click", (e) => {
      e.preventDefault();
      logout();
    });

    // ==========================
    // PATIENTS
    // ==========================
    async function loadPatientsForCurrentUser() {
      patientMap = {};
      patientSelect.innerHTML = `<option value="">‚Äî ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢ ‚Äî</option>`;
      patientInfo.style.display = "none";
      deletePatientBtn.style.display = "none";
      clearHistoryTable();
      clearMonitor();

      if (!currentUserId) return;

      try {
        const url = buildUrl("/patients.json");
        const res = await fetch(url);
        const data = await res.json();
        if (!data) return;

        Object.keys(data).forEach((pid) => {
          const p = data[pid];
          if (!p) return;
          if (p.ownerId !== currentUserId) return;

          patientMap[pid] = p;
          const opt = document.createElement("option");
          const fullName = (p.name || "") + (p.lastname ? " " + p.lastname : "");
          opt.value = pid;
          opt.textContent = `${fullName} (${pid})`;
          patientSelect.appendChild(opt);
        });
      } catch (err) {
        console.error("loadPatientsForCurrentUser error:", err);
      }
    }

    toggleNewPatientBtn.addEventListener("click", () => {
      if (newPatientForm.style.display === "none" || newPatientForm.style.display === "") {
        newPatientForm.style.display = "block";
      } else {
        newPatientForm.style.display = "none";
      }
    });

    savePatientBtn.addEventListener("click", async () => {
      patientMsgEl.textContent = "";
      deleteMsgEl.textContent  = "";

      if (!currentUserId) {
        patientMsgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô";
        patientMsgEl.style.color = "red";
        return;
      }

      const name     = newNameInput.value.trim();
      const id       = newHNInput.value.trim();
      const deviceId = newDeviceInput.value.trim();
      const note     = newNoteInput.value.trim();

      if (!name) {
        patientMsgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ä‡∏∑‡πà‡∏≠-‡∏™‡∏Å‡∏∏‡∏•";
        patientMsgEl.style.color = "red";
        return;
      }
      if (id.length !== 4 || !/^\d{4}$/.test(id)) {
        patientMsgEl.textContent = "‡∏£‡∏´‡∏±‡∏™‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏ï‡πâ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç 4 ‡∏´‡∏•‡∏±‡∏Å (‡πÄ‡∏ä‡πà‡∏ô 0123)";
        patientMsgEl.style.color = "red";
        return;
      }

      const payload = {
        patientId: id,
        name: name,
        lastname: "",
        deviceId: deviceId || "",
        note: note || "",
        ownerId: currentUserId,
        createdAt: Date.now()
      };

      try {
        const url = buildUrl("/patients/" + id + ".json");
        const res = await fetch(url, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        if (!res.ok) throw new Error("HTTP " + res.status);

        patientMsgEl.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        patientMsgEl.style.color = "lightgreen";

        newNameInput.value   = "";
        newHNInput.value     = "";
        newDeviceInput.value = "";
        newNoteInput.value   = "";
        newPatientForm.style.display = "none";

        await loadPatientsForCurrentUser();
        patientSelect.value = id;
        onPatientSelected(id);
      } catch (err) {
        console.error("savePatient error:", err);
        patientMsgEl.textContent = "‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err;
        patientMsgEl.style.color = "red";
      }
    });

    deletePatientBtn.addEventListener("click", async () => {
      deleteMsgEl.textContent = "";
      if (!currentUserId) {
        deleteMsgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡∏Å‡πà‡∏≠‡∏ô";
        deleteMsgEl.style.color = "red";
        return;
      }
      if (!currentPatientId || !patientMap[currentPatientId]) {
        deleteMsgEl.textContent = "‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡∏•‡∏ö";
        deleteMsgEl.style.color = "yellow";
        return;
      }

      const p = patientMap[currentPatientId];
      if (p.ownerId !== currentUserId) {
        deleteMsgEl.textContent = "‡∏Ñ‡∏∏‡∏ì‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏Ñ‡∏ô‡∏ô‡∏µ‡πâ";
        deleteMsgEl.style.color = "red";
        return;
      }

      const ok = window.confirm(
        "‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏£‡∏´‡∏±‡∏™ " + currentPatientId + " ‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?"
      );
      if (!ok) return;

      try {
        // ‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢
        const urlP = buildUrl("/patients/" + currentPatientId + ".json");
        await fetch(urlP, { method: "DELETE" });

        // ‡∏•‡∏ö‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÉ‡∏ô cpm_results ‡∏ó‡∏µ‡πà patientId ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ô
        const urlHist = buildUrl("/cpm_results.json");
        const resH = await fetch(urlHist);
        const histData = await resH.json();

        if (histData) {
          const tasks = [];
          for (const key in histData) {
            const item = histData[key];
            if (item && item.patientId === currentPatientId) {
              const delUrl = buildUrl("/cpm_results/" + key + ".json");
              tasks.push(fetch(delUrl, { method: "DELETE" }));
            }
          }
          await Promise.all(tasks);
        }

        deleteMsgEl.textContent = "‡∏•‡∏ö‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢";
        deleteMsgEl.style.color = "lightgreen";

        currentPatientId = null;
        patientInfo.style.display = "none";
        deletePatientBtn.style.display = "none";
        patientSelect.value = "";
        clearMonitor();
        clearHistoryTable();
        await loadPatientsForCurrentUser();
      } catch (err) {
        console.error("deletePatient error:", err);
        deleteMsgEl.textContent = "‡∏•‡∏ö‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: " + err;
        deleteMsgEl.style.color = "red";
      }
    });

    patientSelect.addEventListener("change", () => {
      const id = patientSelect.value;
      onPatientSelected(id);
    });

    function onPatientSelected(id) {
      deleteMsgEl.textContent = "";
      if (!id || !patientMap[id]) {
        currentPatientId = null;
        patientInfo.style.display = "none";
        deletePatientBtn.style.display = "none";
        clearMonitor();
        clearHistoryTable();
        return;
      }

      currentPatientId = id;
      const p = patientMap[id];

      pNameEl.textContent   = (p.name || "") + (p.lastname ? " " + p.lastname : "");
      pHNEl.textContent     = p.patientId || id;
      pDeviceEl.textContent = p.deviceId || "-";
      pNoteEl.textContent   = p.note || "-";

      patientInfo.style.display = "block";
      deletePatientBtn.style.display = "inline-block";

      loadHistoryForPatient(currentPatientId);
    }

    // ==========================
    // HISTORY from cpm_results
    // ==========================
    async function loadHistoryForPatient(patientId) {
      clearHistoryTable();
      clearMonitor();
      if (!patientId) return;

      try {
        const url = buildUrl("/cpm_results.json");
        const res = await fetch(url);
        const data = await res.json();
        if (!data) return;

        const rows = [];
        for (const key in data) {
          const item = data[key];
          if (!item || item.patientId !== patientId) continue;
          rows.push(item);
        }

        if (rows.length === 0) {
          clearHistoryTable();
          return;
        }

        rows.sort((a, b) => (b.ts || 0) - (a.ts || 0));

        historyBody.innerHTML = "";
        rows.forEach((r) => {
          const tr = document.createElement("tr");
          const tsDisp = r.ts ? formatTimeFromSeconds(r.ts) : "-";
          const angleDisp = (r.angle1 != null && r.angle2 != null)
            ? `${r.angle1}¬∞ - ${r.angle2}¬∞`
            : "-";
          const timeDisp  = (r.workTimeSec != null)
            ? `${r.workTimeSec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (${formatMMSS(r.workTimeSec)})`
            : "-";
          const devDisp   = r.device || r.deviceId || "ESP32-CPM";
          const noteDisp  = r.note || "";

          tr.innerHTML = `
            <td>${tsDisp}</td>
            <td>${angleDisp}</td>
            <td>${timeDisp}</td>
            <td>${devDisp}</td>
            <td>${noteDisp}</td>
          `;
          historyBody.appendChild(tr);
        });

        const latest = rows[0];
        stateEl.textContent = "FINISHED";
        angleEl.textContent = (latest.angle1 != null && latest.angle2 != null)
          ? `${latest.angle1}¬∞ - ${latest.angle2}¬∞`
          : "-";
        remEl.textContent   = (latest.workTimeSec != null)
          ? `${latest.workTimeSec} ‡∏ß‡∏¥‡∏ô‡∏≤‡∏ó‡∏µ (${formatMMSS(latest.workTimeSec)})`
          : "-";
        timeEl.textContent  = latest.ts ? formatTimeFromSeconds(latest.ts) : "-";
      } catch (err) {
        console.error("loadHistoryForPatient error:", err);
      }
    }

    // ==========================
    // SWITCH main/history
    // ==========================
    toHistoryBtn.addEventListener("click", () => {
      historyPage.style.display = "block";
      mainPage.style.display    = "none";
    });

    backToMainBtn.addEventListener("click", () => {
      historyPage.style.display = "none";
      mainPage.style.display    = "block";
    });

    backToLoginFromHistoryBtn.addEventListener("click", () => {
      showLoginUI();
    });

    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    document.addEventListener("DOMContentLoaded", () => {
      showLoginUI();
    });
  </script>
</body>
</html>


