<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8">
  <title>CPM Monitor</title>

  <base href="/cpmpateint-data/">
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
<div class="bg-overlay"></div>

<div id="appWrapper">
  <!-- โลโก้ -->
  <div class="logo-block">
    <div class="logo-circle">CPM</div>
    <div class="logo-text">
      <h1>CPM Monitor</h1>
      <p>Continuous Passive Motion Dashboard</p>
    </div>
  </div>

  <!-- ========== LOGIN ========== -->
  <div id="loginBox" class="card">
    <h3>เข้าสู่ระบบ</h3>

    <label class="field-label">ชื่อผู้ใช้</label>
    <input id="username" type="text" placeholder="เช่น SS1">

    <label class="field-label">รหัสผ่าน</label>
    <input id="password" type="password" placeholder="รหัสผ่าน">

    <div class="button-row">
      <button id="loginBtn" class="btn primary">เข้าสู่ระบบ</button>
      <button id="goRegisterBtn" class="btn ghost small">สมัครสมาชิก</button>
    </div>

    <button id="fullscreenBtn" class="btn ghost small fs-btn">
      เต็มหน้าจอ
    </button>

    <p id="loginMsg" class="msg"></p>
  </div>

  <!-- ========== REGISTER ========== -->
  <div id="registerBox" class="card" style="display:none;">
    <h3>สมัครสมาชิก</h3>

    <label class="field-label">ชื่อผู้ใช้</label>
    <input id="regUsername" type="text" placeholder="กำหนดชื่อผู้ใช้ เช่น SS1">

    <label class="field-label">รหัสผ่าน</label>
    <input id="regPassword" type="password" placeholder="กำหนดรหัสผ่าน">

    <div class="button-row">
      <button id="registerSubmitBtn" class="btn primary">สมัครสมาชิก</button>
      <button id="backToLoginBtn" class="btn ghost small">กลับหน้าเข้าสู่ระบบ</button>
    </div>

    <p id="registerMsg" class="msg"></p>
  </div>

  <!-- ========== MAIN PAGE ========== -->
  <div id="mainPage" style="display:none;">
    <!-- แถบผู้ใช้ -->
    <div class="card" id="userBox">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span>เข้าสู่ระบบเป็น: <strong id="currentUserLabel">-</strong></span>
        <button id="logoutBtn" class="btn danger small">ออกจากระบบ</button>
      </div>
    </div>

    <!-- ผู้ป่วย -->
    <div id="patientBox" class="card" style="display:none;">
      <h3>เลือกผู้ป่วย</h3>

      <div class="field-group">
        <label class="field-label">ผู้ป่วย</label>
        <select id="patientSelect">
          <option value="">— เลือกผู้ป่วย —</option>
        </select>
      </div>

      <div id="patientInfo" class="patient-info" style="display:none;">
        <div><span class="label">ชื่อ-สกุล:</span> <span id="pName" class="value-sm">-</span></div>
        <div><span class="label">รหัสผู้ป่วย (4 หลัก):</span> <span id="pHN" class="value-sm">-</span></div>
        <div><span class="label">Device ID:</span> <span id="pDevice" class="pill-dev">-</span></div>
        <div><span class="label">หมายเหตุ:</span> <span id="pNote" class="value-sm">-</span></div>
      </div>

      <hr class="divider">

      <button id="toggleNewPatientBtn" class="btn ghost small">
        + สร้างข้อมูลผู้ป่วยใหม่
      </button>

      <div id="newPatientForm" class="new-patient" style="display:none;">
        <h4>เพิ่มผู้ป่วยใหม่</h4>

        <label class="field-label">ชื่อ-สกุล</label>
        <input id="newName" type="text" placeholder="เช่น นาย กายภาพ ตัวอย่าง">

        <label class="field-label">รหัสผู้ป่วย (4 หลัก)</label>
        <input id="newHN" type="text" maxlength="4" placeholder="เช่น 0123">

        <label class="field-label">Device ID ที่ใช้งาน (เช่น CPM01)</label>
        <input id="newDeviceId" type="text" placeholder="เช่น CPM01">

        <label class="field-label">หมายเหตุเพิ่มเติม</label>
        <textarea id="newNote" rows="2" placeholder="เช่น ข้อเท้าขวา post-op 3 วัน"></textarea>

        <button id="savePatientBtn" class="btn primary small">บันทึกผู้ป่วย</button>
        <p id="patientMsg" class="msg"></p>
      </div>

      <div class="button-row" style="margin-top:8px;">
        <button id="deletePatientBtn" class="btn danger small" style="display:none;">
          ลบผู้ป่วยนี้ (พร้อมประวัติ)
        </button>
      </div>
      <p id="deleteMsg" class="msg"></p>
    </div>

    <!-- Monitor -->
    <div id="monitorBox" class="card monitor" style="display:none;">
      <h3>สถานะเครื่อง CPM</h3>
      <div id="statusBox">
        <div class="item-row">
          <span class="label">สถานะ</span>
          <span class="value-pill" id="stateText">-</span>
        </div>
        <div class="item-row">
          <span class="label">มุมใช้งานครั้งล่าสุด</span>
          <span class="value" id="angleText">-</span>
        </div>
        <div class="item-row">
          <span class="label">ระยะเวลา</span>
          <span class="value" id="remText">-</span>
        </div>
        <div class="item-row">
          <span class="label">อัปเดตล่าสุด</span>
          <span class="value time" id="timeText">-</span>
        </div>
      </div>
    </div>

    <div id="mainNavRow" class="nav-row" style="display:none;">
      <button id="toHistoryBtn" class="btn ghost small">หน้าถัดไป (ประวัติผู้ป่วย)</button>
    </div>
  </div>

  <!-- ========== HISTORY ========== -->
  <div id="historyPage" class="card history" style="display:none;">
    <div class="history-header">
      <h3>ประวัติการทำ CPM</h3>
      <p class="history-sub">แสดงประวัติของผู้ป่วยที่เลือก (จาก Firebase)</p>
    </div>

    <table class="history-table">
      <thead>
        <tr>
          <th>วันที่ / เวลา</th>
          <th>มุมที่ใช้</th>
          <th>ระยะเวลา</th>
          <th>Device</th>
          <th>หมายเหตุ</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <tr><td colspan="5" class="empty">ยังไม่มีข้อมูล</td></tr>
      </tbody>
    </table>

    <div class="nav-row">
      <button id="backToMainBtn" class="btn ghost small">ย้อนกลับหน้าหลัก</button>
      <button id="backToLoginFromHistoryBtn" class="btn danger small">กลับหน้าเข้าสู่ระบบ</button>
    </div>
  </div>
</div>

<script>
  // ==========================
  // Firebase Realtime DB (REST)
  // ==========================
  const FIREBASE_URL  = "https://ankle-cpm-default-rtdb.asia-southeast1.firebasedatabase.app";
  const FIREBASE_AUTH = null; // ถ้าใช้ token ใส่ตรงนี้

  function buildUrl(path) {
    let url = FIREBASE_URL + path;
    if (FIREBASE_AUTH) {
      const sep = url.includes("?") ? "&" : "?";
      url += sep + "auth=" + FIREBASE_AUTH;
    }
    return url;
  }

  // ===== DOM =====
  const loginBox    = document.getElementById("loginBox");
  const registerBox = document.getElementById("registerBox");
  const mainPage    = document.getElementById("mainPage");
  const historyPage = document.getElementById("historyPage");

  const usernameInput = document.getElementById("username");
  const passwordInput = document.getElementById("password");
  const loginBtn      = document.getElementById("loginBtn");
  const goRegisterBtn = document.getElementById("goRegisterBtn");
  const loginMsg      = document.getElementById("loginMsg");
  const fullscreenBtn = document.getElementById("fullscreenBtn");

  const regUsernameInput  = document.getElementById("regUsername");
  const regPasswordInput  = document.getElementById("regPassword");
  const registerSubmitBtn = document.getElementById("registerSubmitBtn");
  const backToLoginBtn    = document.getElementById("backToLoginBtn");
  const registerMsg       = document.getElementById("registerMsg");

  const logoutBtn        = document.getElementById("logoutBtn");
  const currentUserLabel = document.getElementById("currentUserLabel");

  const patientBox    = document.getElementById("patientBox");
  const monitorBox    = document.getElementById("monitorBox");
  const mainNavRow    = document.getElementById("mainNavRow");
  const patientSelect = document.getElementById("patientSelect");
  const patientInfo   = document.getElementById("patientInfo");
  const pNameEl       = document.getElementById("pName");
  const pHNEl         = document.getElementById("pHN");
  const pDeviceEl     = document.getElementById("pDevice");
  const pNoteEl       = document.getElementById("pNote");

  const toggleNewPatientBtn = document.getElementById("toggleNewPatientBtn");
  const newPatientForm      = document.getElementById("newPatientForm");
  const newNameInput        = document.getElementById("newName");
  const newHNInput          = document.getElementById("newHN");
  const newDeviceInput      = document.getElementById("newDeviceId");
  const newNoteInput        = document.getElementById("newNote");
  const savePatientBtn      = document.getElementById("savePatientBtn");
  const patientMsgEl        = document.getElementById("patientMsg");
  const deletePatientBtn    = document.getElementById("deletePatientBtn");
  const deleteMsgEl         = document.getElementById("deleteMsg");

  const stateEl  = document.getElementById("stateText");
  const angleEl  = document.getElementById("angleText");
  const remEl    = document.getElementById("remText");
  const timeEl   = document.getElementById("timeText");

  const historyBody               = document.getElementById("historyBody");
  const toHistoryBtn              = document.getElementById("toHistoryBtn");
  const backToMainBtn             = document.getElementById("backToMainBtn");
  const backToLoginFromHistoryBtn = document.getElementById("backToLoginFromHistoryBtn");

  // ===== STATE =====
  let currentUserId    = null;
  let patientMap       = {};
  let currentPatientId = null;

  // ===== Helpers =====
  function formatMMSS(sec) {
    sec = Math.max(0, sec | 0);
    const m  = Math.floor(sec / 60);
    const s  = sec % 60;
    const mm = (m < 10 ? "0" : "") + m;
    const ss = (s < 10 ? "0" : "") + s;
    return `${mm}:${ss}`;
  }
  function formatTimeFromSeconds(tsSec) {
    if (!tsSec) return "-";
    const d = new Date(tsSec * 1000);
    const pad = (n)=>n.toString().padStart(2,"0");
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()+543} ${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;
  }
  function clearMonitor(){
    stateEl.textContent="-";
    angleEl.textContent="-";
    remEl.textContent="-";
    timeEl.textContent="-";
  }
  function clearHistoryTable(){
    historyBody.innerHTML = `<tr><td colspan="5" class="empty">ยังไม่มีข้อมูล</td></tr>`;
  }

  // ===== UI switch =====
  function showLoginUI(){
    loginBox.style.display    = "block";
    registerBox.style.display = "none";
    mainPage.style.display    = "none";
    historyPage.style.display = "none";
    logoutBtn.style.display   = "none";

    currentUserId = null;
    currentUserLabel.textContent = "-";
    patientMap       = {};
    currentPatientId = null;
    patientSelect.innerHTML = `<option value="">— เลือกผู้ป่วย —</option>`;
    patientInfo.style.display = "none";
    deletePatientBtn.style.display = "none";
    clearMonitor();
    clearHistoryTable();
    loginMsg.textContent    = "";
    registerMsg.textContent = "";
  }
  function showRegisterUI(){
    loginBox.style.display    = "none";
    registerBox.style.display = "block";
    mainPage.style.display    = "none";
    historyPage.style.display = "none";
    registerMsg.textContent   = "";
  }
  function showMainUI(){
    loginBox.style.display    = "none";
    registerBox.style.display = "none";
    mainPage.style.display    = "block";
    historyPage.style.display = "none";
    patientBox.style.display  = "block";
    monitorBox.style.display  = "block";
    mainNavRow.style.display  = "block";
    logoutBtn.style.display   = "inline-block";
    currentUserLabel.textContent = currentUserId || "-";
  }

  fullscreenBtn.addEventListener("click",()=>{
    if(!document.fullscreenElement){
      document.documentElement.requestFullscreen().catch(console.error);
    }else{
      document.exitFullscreen();
    }
  });

  // ===== REGISTER USER =====
  async function registerUser(username,password){
    const u = username.trim();
    const p = password.trim();
    if(!u || !p){
      registerMsg.textContent="กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
      registerMsg.style.color="yellow";
      return;
    }
    try{
      const url = buildUrl("/users/"+encodeURIComponent(u)+".json");
      const res = await fetch(url);
      if(!res.ok){
        registerMsg.textContent="อ่านข้อมูลจาก Firebase ไม่ได้ ("+res.status+")";
        registerMsg.style.color="red";
        return;
      }
      const existing = await res.json();
      console.log("existing user data =",existing);

      if(existing && typeof existing==="object" && existing.password!==undefined){
        registerMsg.textContent="มีผู้ใช้นี้อยู่แล้ว กรุณาใช้ชื่ออื่น";
        registerMsg.style.color="red";
        return;
      }

      const payload={password:p,createdAt:Date.now()};
      const putRes = await fetch(url,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(!putRes.ok) throw new Error("HTTP "+putRes.status);

      registerMsg.textContent="สมัครสมาชิกสำเร็จ กำลังกลับหน้าเข้าสู่ระบบ...";
      registerMsg.style.color="lightgreen";
      setTimeout(showLoginUI,1500);
    }catch(err){
      console.error("registerUser error:",err);
      registerMsg.textContent="สมัครสมาชิกไม่สำเร็จ: "+err;
      registerMsg.style.color="red";
    }
  }

  // ===== LOGIN USER =====
  async function loginUser(username,password){
    const u = username.trim();
    const p = password.trim();
    if(!u || !p){
      loginMsg.textContent="กรุณากรอกชื่อผู้ใช้และรหัสผ่าน";
      loginMsg.style.color="yellow";
      return;
    }
    try{
      const url = buildUrl("/users/"+encodeURIComponent(u)+".json");
      const res = await fetch(url);
      if(!res.ok){
        loginMsg.textContent="อ่านข้อมูลผู้ใช้ไม่ได้ ("+res.status+")";
        loginMsg.style.color="red";
        return;
      }
      const data = await res.json();
      console.log("login user data =",data);

      if(!data || typeof data!=="object" || data.password===undefined){
        loginMsg.textContent="ไม่พบชื่อผู้ใช้นี้";
        loginMsg.style.color="red";
        return;
      }
      if(data.password!==p){
        loginMsg.textContent="รหัสผ่านไม่ถูกต้อง";
        loginMsg.style.color="red";
        return;
      }

      currentUserId = u;
      currentUserLabel.textContent = u;
      loginMsg.textContent = "";
      showMainUI();
      await loadPatientsForCurrentUser();
    }catch(err){
      console.error("loginUser error:",err);
      loginMsg.textContent="เข้าสู่ระบบไม่สำเร็จ: "+err;
      loginMsg.style.color="red";
    }
  }

  function logout(){
    usernameInput.value="";
    passwordInput.value="";
    showLoginUI();
  }

  // ===== EVENTS login/register =====
  loginBtn.addEventListener("click",e=>{
    e.preventDefault();
    loginUser(usernameInput.value,passwordInput.value);
  });
  goRegisterBtn.addEventListener("click",e=>{
    e.preventDefault();
    showRegisterUI();
  });
  registerSubmitBtn.addEventListener("click",e=>{
    e.preventDefault();
    registerUser(regUsernameInput.value,regPasswordInput.value);
  });
  backToLoginBtn.addEventListener("click",e=>{
    e.preventDefault();
    showLoginUI();
  });
  logoutBtn.addEventListener("click",e=>{
    e.preventDefault();
    logout();
  });

  // ===== PATIENTS =====
  async function loadPatientsForCurrentUser(){
    patientMap={};
    patientSelect.innerHTML=`<option value="">— เลือกผู้ป่วย —</option>`;
    patientInfo.style.display="none";
    deletePatientBtn.style.display="none";
    clearHistoryTable();
    clearMonitor();
    if(!currentUserId) return;

    try{
      const url = buildUrl("/patients.json");
      const res = await fetch(url);
      const data = await res.json();
      if(!data) return;
      Object.keys(data).forEach(pid=>{
        const p=data[pid];
        if(!p) return;
        if(p.ownerId!==currentUserId) return;
        patientMap[pid]=p;
        const opt=document.createElement("option");
        const fullname=(p.name||"")+(p.lastname?(" "+p.lastname):"");
        opt.value=pid;
        opt.textContent=`${fullname} (${pid})`;
        patientSelect.appendChild(opt);
      });
    }catch(err){
      console.error("loadPatientsForCurrentUser error:",err);
    }
  }

  toggleNewPatientBtn.addEventListener("click",()=>{
    newPatientForm.style.display =
      (newPatientForm.style.display==="block")?"none":"block";
  });

  savePatientBtn.addEventListener("click",async()=>{
    patientMsgEl.textContent="";
    deleteMsgEl.textContent="";
    if(!currentUserId){
      patientMsgEl.textContent="กรุณาเข้าสู่ระบบก่อน";
      patientMsgEl.style.color="red";
      return;
    }
    const name=newNameInput.value.trim();
    const id=newHNInput.value.trim();
    const deviceId=newDeviceInput.value.trim();
    const note=newNoteInput.value.trim();

    if(!name){
      patientMsgEl.textContent="กรุณากรอกชื่อ-สกุล";
      patientMsgEl.style.color="red"; return;
    }
    if(id.length!==4 || !/^\d{4}$/.test(id)){
      patientMsgEl.textContent="รหัสผู้ป่วยต้องเป็นตัวเลข 4 หลัก (เช่น 0123)";
      patientMsgEl.style.color="red"; return;
    }
    const payload={
      patientId:id,
      name,
      lastname:"",
      deviceId:deviceId||"",
      note:note||"",
      ownerId:currentUserId,
      createdAt:Date.now()
    };
    try{
      const url=buildUrl("/patients/"+id+".json");
      const res=await fetch(url,{
        method:"PUT",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify(payload)
      });
      if(!res.ok) throw new Error("HTTP "+res.status);
      patientMsgEl.textContent="บันทึกข้อมูลผู้ป่วยเรียบร้อย";
      patientMsgEl.style.color="lightgreen";

      newNameInput.value="";
      newHNInput.value="";
      newDeviceInput.value="";
      newNoteInput.value="";
      newPatientForm.style.display="none";

      await loadPatientsForCurrentUser();
      patientSelect.value=id;
      onPatientSelected(id);
    }catch(err){
      console.error("savePatient error:",err);
      patientMsgEl.textContent="บันทึกไม่สำเร็จ: "+err;
      patientMsgEl.style.color="red";
    }
  });

  deletePatientBtn.addEventListener("click",async()=>{
    deleteMsgEl.textContent="";
    if(!currentUserId){
      deleteMsgEl.textContent="กรุณาเข้าสู่ระบบก่อน";
      deleteMsgEl.style.color="red"; return;
    }
    if(!currentPatientId || !patientMap[currentPatientId]){
      deleteMsgEl.textContent="กรุณาเลือกผู้ป่วยก่อนลบ";
      deleteMsgEl.style.color="yellow"; return;
    }
    const p=patientMap[currentPatientId];
    if(p.ownerId!==currentUserId){
      deleteMsgEl.textContent="คุณไม่มีสิทธิ์ลบผู้ป่วยคนนี้";
      deleteMsgEl.style.color="red"; return;
    }
    const ok=window.confirm("ยืนยันลบผู้ป่วยรหัส "+currentPatientId+" และประวัติทั้งหมด?");
    if(!ok) return;
    try{
      const urlP=buildUrl("/patients/"+currentPatientId+".json");
      await fetch(urlP,{method:"DELETE"});

      const urlHist=buildUrl("/cpm_results.json");
      const resH=await fetch(urlHist);
      const histData=await resH.json();
      if(histData){
        const tasks=[];
        const pidStr = String(currentPatientId);
        for(const key in histData){
          const item=histData[key];
          if(item && String(item.patientId)===pidStr){
            tasks.push(fetch(buildUrl("/cpm_results/"+key+".json"),{method:"DELETE"}));
          }
        }
        await Promise.all(tasks);
      }

      deleteMsgEl.textContent="ลบผู้ป่วยและประวัติเรียบร้อย";
      deleteMsgEl.style.color="lightgreen";

      currentPatientId=null;
      patientInfo.style.display="none";
      deletePatientBtn.style.display="none";
      patientSelect.value="";
      clearMonitor();
      clearHistoryTable();
      await loadPatientsForCurrentUser();
    }catch(err){
      console.error("deletePatient error:",err);
      deleteMsgEl.textContent="ลบไม่สำเร็จ: "+err;
      deleteMsgEl.style.color="red";
    }
  });

  patientSelect.addEventListener("change",()=>{
    onPatientSelected(patientSelect.value);
  });

  function onPatientSelected(id){
    deleteMsgEl.textContent="";
    if(!id || !patientMap[id]){
      currentPatientId=null;
      patientInfo.style.display="none";
      deletePatientBtn.style.display="none";
      clearMonitor();
      clearHistoryTable();
      return;
    }
    currentPatientId=id;
    const p=patientMap[id];
    pNameEl.textContent=(p.name||"")+(p.lastname?(" "+p.lastname):"");
    pHNEl.textContent=p.patientId||id;
    pDeviceEl.textContent=p.deviceId||"-";
    pNoteEl.textContent=p.note||"-";
    patientInfo.style.display="block";
    deletePatientBtn.style.display="inline-block";
    loadHistoryForPatient(currentPatientId);
  }

  // ===== HISTORY =====
  async function loadHistoryForPatient(patientId) {
    clearHistoryTable();
    clearMonitor();
    if (!patientId) return;

    try {
      const url = buildUrl("/cpm_results.json");
      const res = await fetch(url);
      const data = await res.json();
      if (!data) return;

      const pidStr = String(patientId);
      const rows = [];

      for (const key in data) {
        const item = data[key];
        if (!item) continue;

        const recPid = (item.patientId !== undefined && item.patientId !== null)
          ? String(item.patientId)
          : "";

        if (recPid !== pidStr) continue;

        rows.push(item);
      }

      if (rows.length === 0) {
        clearHistoryTable();
        return;
      }

      rows.sort((a, b) => (b.ts || 0) - (a.ts || 0));

      historyBody.innerHTML = "";

      rows.forEach((r) => {
        const tr = document.createElement("tr");

        const tsDisp = r.ts ? formatTimeFromSeconds(r.ts) : "-";
        const angleDisp =
          r.angle1 != null && r.angle2 != null
            ? `${r.angle1}° - ${r.angle2}°`
            : "-";
        const timeDisp =
          r.workTimeSec != null
            ? `${r.workTimeSec} วินาที (${formatMMSS(r.workTimeSec)})`
            : "-";
        const devDisp = r.device || r.deviceId || "ESP32-CPM";
        const noteDisp = r.note || "";

        tr.innerHTML = `
          <td>${tsDisp}</td>
          <td>${angleDisp}</td>
          <td>${timeDisp}</td>
          <td>${devDisp}</td>
          <td>${noteDisp}</td>
        `;
        historyBody.appendChild(tr);
      });

      const latest = rows[0];
      stateEl.textContent = "FINISHED";
      angleEl.textContent =
        latest.angle1 != null && latest.angle2 != null
          ? `${latest.angle1}° - ${latest.angle2}°`
          : "-";
      remEl.textContent =
        latest.workTimeSec != null
          ? `${latest.workTimeSec} วินาที (${formatMMSS(latest.workTimeSec)})`
          : "-";
      timeEl.textContent = latest.ts ? formatTimeFromSeconds(latest.ts) : "-";
    } catch (err) {
      console.error("loadHistoryForPatient error:", err);
    }
  }

  // ===== NAV HISTORY =====
  toHistoryBtn.addEventListener("click",()=>{
    historyPage.style.display="block";
    mainPage.style.display="none";
  });
  backToMainBtn.addEventListener("click",()=>{
    historyPage.style.display="none";
    mainPage.style.display="block";
  });
  backToLoginFromHistoryBtn.addEventListener("click",()=>{
    showLoginUI();
  });

  document.addEventListener("DOMContentLoaded",showLoginUI);
</script>
</body>
</html>
